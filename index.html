<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ’çƒæ’²å…‹ç‰Œæ•¸ä½ç‰ˆ</title>
    
    <script type="module">
        // --- 1. å¼•å…¥æ‰€éœ€çš„ Firebase SDK æ¨¡çµ„ (åŒ…å« Firestore) ---
        // ç‰ˆæœ¬è™Ÿç‚º 12.6.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- 2. æ‚¨çš„ Firebase é€£ç·šè¨­å®š (å·²å¡«å…¥æ‚¨çš„è³‡è¨Š) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0",
            authDomain: "poolpokergame-b88ed.firebaseapp.com",
            projectId: "poolpokergame-b88ed",
            storageBucket: "poolpokergame-b88ed.firebasestorage.app",
            messagingSenderId: "574863840102",
            appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
        };

        // --- 3. åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œè³‡æ–™åº« ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // åˆå§‹åŒ– Firestore è³‡æ–™åº«

        // ==========================================================
        // éŠæˆ²æ ¸å¿ƒé‚è¼¯é–‹å§‹
        // ==========================================================
        
        // æ ¸å¿ƒè®Šæ•¸
        const GAME_ID = "main_pool_game_demo"; 
        // ä½¿ç”¨ localStorage å„²å­˜ç©å®¶åç¨±ï¼Œè®“ç©å®¶é‡æ–°æ•´ç†å¾Œä¸éœ€è¦å†æ¬¡è¼¸å…¥
        let playerName = localStorage.getItem('playerName') || ''; 

        // --- 1. éŠæˆ²åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!playerName) {
                playerName = prompt("æ­¡è¿ï¼è«‹è¼¸å…¥æ‚¨çš„ç©å®¶åç¨±:");
                if (playerName) {
                    localStorage.setItem('playerName', playerName);
                } else {
                    document.body.innerHTML = "è«‹é‡æ–°æ•´ç†ä¸¦è¼¸å…¥åç¨±ã€‚";
                    return;
                }
            }
            document.getElementById('player-name-display').textContent = `ç©å®¶ï¼š${playerName}`;
            setupGameListeners();
        });

        // --- 2. ç™¼ç‰Œé‚è¼¯ (ç”±ç¬¬ä¸€å€‹é»æ“Šçš„äººåŸ·è¡Œ) ---
        async function initialDealCards(playersCount) {
            const gameRef = doc(db, "games", GAME_ID);
            const docSnap = await getDoc(gameRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                // å¦‚æœéŠæˆ²å·²é–‹å§‹ï¼Œä¸å†ç™¼ç‰Œ
                if (data.status === 'in_progress') {
                     alert("éŠæˆ²å·²ç¶“åœ¨é€²è¡Œä¸­ï¼Œè«‹å‹¿é‡è¤‡ç™¼ç‰Œï¼");
                     return;
                }
                
                // ç²å–æ‰€æœ‰å·²è¨»å†Šçš„ç©å®¶åç¨± (é€™æ˜¯é—œéµï¼ç¢ºä¿æ‰€æœ‰ç©å®¶éƒ½å·²è¼‰å…¥ç¶²é )
                const allRegisteredPlayers = Object.keys(data.players || {});
                
                // æª¢æŸ¥è¨»å†Šäººæ•¸æ˜¯å¦è¶³å¤ 
                if (allRegisteredPlayers.length < playersCount) {
                    alert(`ç›®å‰åªæœ‰ ${allRegisteredPlayers.length} ä½ç©å®¶è¨»å†Šï¼Œè«‹ç­‰å€™å…¶ä»–ç©å®¶åŠ å…¥ä¸¦é‡æ–°å˜—è©¦ç™¼ç‰Œã€‚`);
                    return;
                }
                
                // --- æ´—ç‰Œèˆ‡ç™¼ç‰Œç¨‹åº ---
                const deck = Array.from({ length: 52 }, (_, i) => i + 1); 
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }

                const allHands = {};
                let remainingDeck = deck;
                
                // æŒ‰ç…§è¨»å†Šçš„ç©å®¶åç¨±åˆ—è¡¨ä¾åºç™¼ç‰Œ
                for (let i = 0; i < playersCount; i++) {
                    const hand = remainingDeck.slice(0, 8); // æŠ½å– 8 å¼µ
                    remainingDeck = remainingDeck.slice(8); 
                    const playerKey = allRegisteredPlayers[i]; // ä½¿ç”¨å¯¦éš›è¨»å†Šçš„ç©å®¶åç¨±ä½œç‚ºéµå€¼
                    allHands[playerKey] = hand;
                }
                
                // å°‡æ•´å€‹éŠæˆ²çš„ç‹€æ…‹å¯«å…¥ Firestore
                await setDoc(gameRef, {
                    status: 'in_progress',
                    active_balls: [], 
                    players: allHands, 
                    active_players: allRegisteredPlayers.slice(0, playersCount) // è¨˜éŒ„åƒèˆ‡ç©å®¶çš„åç¨±åˆ—è¡¨
                }, { merge: true });

                alert(`ç™¼ç‰Œå®Œæˆï¼å·²åˆ†ç™¼çµ¦ ${playersCount} ä½ç©å®¶ã€‚`);

            } else {
                 alert("éŠæˆ²æ–‡ä»¶å°šæœªå‰µå»ºï¼Œè«‹ç­‰å€™è‡³å°‘ä¸€ä½ç©å®¶è¼‰å…¥ç¶²é ã€‚");
            }
        }

        document.getElementById('start-game-btn').onclick = () => {
            const count = prompt("è«‹è¼¸å…¥ç©å®¶äººæ•¸ (2-4):");
            const playersCount = parseInt(count);
            if (playersCount >= 2 && playersCount <= 4) {
                initialDealCards(playersCount);
            } else {
                alert("äººæ•¸ç„¡æ•ˆã€‚");
            }
        };

        // --- 3. å¯¦æ™‚ç›£è½èˆ‡ç©å®¶è¨»å†Šé‚è¼¯ (ä¿®æ”¹) ---
        function setupGameListeners() {
            const gameRef = doc(db, "games", GAME_ID);
            
            // --- è¨»å†Šç©å®¶ï¼šç¢ºä¿è‡ªå·±çš„åç¨±å­˜åœ¨æ–¼ Firestore ä¸­ ---
            async function registerPlayer() {
                const docSnap = await getDoc(gameRef);
                let playersMap = {};

                if (docSnap.exists()) {
                    playersMap = docSnap.data().players || {};
                }
                
                // å¦‚æœç©å®¶åç¨±ä¸åœ¨ç›®å‰çš„ players åˆ—è¡¨ä¸­ï¼Œå‰‡æ–°å¢ä¸€å€‹ç©ºçš„ç‰Œçµ„ (é€™æ¨£ç™¼ç‰Œæ™‚å°±çŸ¥é“æœ‰é€™å€‹ç©å®¶)
                if (!playersMap[playerName]) {
                    playersMap[playerName] = []; 
                    await setDoc(gameRef, { players: playersMap }, { merge: true });
                    console.log(`ç©å®¶ ${playerName} å·²è¨»å†Šã€‚`);
                }
            }
            registerPlayer(); // æ¯æ¬¡è¼‰å…¥éƒ½å˜—è©¦è¨»å†Š

            // --- ç›£è½éŠæˆ²ç‹€æ…‹çš„è®ŠåŒ– (æ ¸å¿ƒçš„å³æ™‚åŒæ­¥åŠŸèƒ½ï¼) ---
            onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // å–å¾—ç›®å‰æ‰€æœ‰å·²æ¶ˆé™¤çš„çƒè™Ÿ (1-13)
                    const activeBalls = data.active_balls || [];
                    
                    // å¾ Firestore æ•¸æ“šä¸­ï¼Œä½¿ç”¨è‡ªå·±çš„åç¨±ä¾†å–å¾—æ‰‹ç‰Œ (ä¿®æ­£å¾Œçš„é—œéµï¼)
                    const myHandRaw = data.players[playerName] || []; 
                    
                    // é¡¯ç¤ºæ‰‹ç‰Œèˆ‡æ¶ˆé™¤ç‹€æ…‹
                    displayPlayerHand(myHandRaw, activeBalls);
                    displayBallButtons(activeBalls);

                    console.log("å³æ™‚è³‡æ–™æ›´æ–°ï¼š", data);
                } else {
                    document.getElementById('hand-display').innerHTML = "éŠæˆ²å°šæœªé–‹å§‹ï¼Œè«‹é»æ“Šé–‹å§‹éŠæˆ²ã€‚";
                }
            });
        }
        
        // å°‡ç‰Œè™Ÿ (1-52) è½‰æ›ç‚ºæ’çƒé»æ•¸ (1-13)
        function cardToBallNumber(cardNumber) {
            return ((cardNumber - 1) % 13) + 1; 
        }

        // é¡¯ç¤ºç©å®¶æ‰‹ç‰Œçš„å‡½å¼
        function displayPlayerHand(hand, activeBalls) {
            const display = document.getElementById('hand-display');
            display.innerHTML = '';
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºå‹åˆ©æ¢ä»¶
            if (hand.length > 0 && hand.every(cardNum => activeBalls.includes(cardToBallNumber(cardNum)))) {
                display.innerHTML = '<h2>æ­å–œï¼æ‚¨çš„ç‰Œå·²å…¨éƒ¨æ¶ˆé™¤ï¼æ‚¨æ˜¯è´å®¶ï¼ ğŸ‰</h2>';
                return;
            }
            if (hand.length === 0 && activeBalls.length > 0) {
                 display.innerHTML = 'ç­‰å¾…éŠæˆ²é–‹å§‹æˆ–æ‚¨ä¸æ˜¯åƒèˆ‡çš„ç©å®¶ã€‚';
                 return;
            }
            if (hand.length === 0 && activeBalls.length === 0) {
                 display.innerHTML = 'ç­‰å¾…ç™¼ç‰Œ...';
                 return;
            }


            hand.forEach(cardNum => {
                const ballNum = cardToBallNumber(cardNum);
                const isCleared = activeBalls.includes(ballNum);
                const cardDiv = document.createElement('div');
                cardDiv.className = isCleared ? 'card cleared' : 'card';
                cardDiv.textContent = `ç‰Œè™Ÿ ${cardNum} (çƒè™Ÿ ${ballNum})`;
                if (isCleared) cardDiv.textContent += ' [å·²æ¶ˆé™¤]';
                display.appendChild(cardDiv);
            });
        }
        
        // é¡¯ç¤ºæ¶ˆé™¤æŒ‰éˆ•çš„å‡½å¼
        function displayBallButtons(activeBalls) {
             const ballContainer = document.getElementById('ball-buttons');
             ballContainer.innerHTML = '';
             for (let i = 1; i <= 13; i++) {
                const button = document.createElement('button');
                button.textContent = `æ¶ˆé™¤ ${i} è™Ÿçƒ`;
                button.disabled = activeBalls.includes(i); 
                button.onclick = () => markBallCleared(i);
                ballContainer.appendChild(button);
             }
        }
        
        // --- 4. æ¶ˆé™¤æ©Ÿåˆ¶ (å¯«å…¥è³‡æ–™åº«) ---
        async function markBallCleared(ballNumber) {
            const gameRef = doc(db, "games", GAME_ID);
            
            const docSnap = await getDoc(gameRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const currentBalls = data.active_balls || [];
                
                if (!currentBalls.includes(ballNumber)) {
                    // å°‡æ–°çš„çƒè™Ÿæ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œä¸¦å¯«å›è³‡æ–™åº«
                    const newBalls = [...currentBalls, ballNumber];
                    await setDoc(gameRef, { active_balls: newBalls }, { merge: true });
                }
            }
        }
    </script>

    <style>
        .container { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { border: 1px solid #ccc; padding: 10px; margin: 5px; display: inline-block; background: #fff; }
        .cleared { background-color: #fdd; text-decoration: line-through; border-color: red; }
        #ball-buttons button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #ball-buttons button:disabled { background-color: #eee; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ’çƒæ’²å…‹ç‰Œæ•¸ä½ç‰ˆ (ç°¡æ˜“ç‰ˆ)</h1>
        <p id="player-name-display">ç©å®¶ï¼š(è¼‰å…¥ä¸­)</p>
        
        <h2>éŠæˆ²æ§åˆ¶</h2>
        <button id="start-game-btn">é–‹å§‹éŠæˆ²ä¸¦ç™¼ç‰Œ (ç¬¬ä¸€æ¬¡é»æ“Š)</button>
        <hr>

        <h2>æ¶ˆé™¤æŒ‰éˆ• (çƒæ¡Œ)</h2>
        <div id="ball-buttons">
            </div>
        <hr>
        
        <h2>æˆ‘çš„æ‰‹ç‰Œ</h2>
        <div id="hand-display">
            </div>

    </div>
</body>
</html>

