<!DOCTYPE html>

<html lang="zh-TW">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Pool Poker</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>

  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>

  <style>

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: white; }

    

    /* Pool Ball Styles */

    .ball {

      box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 2px 2px 5px rgba(0,0,0,0.3);

    }

    .stripe-ball {

      background: white;

      position: relative;

      overflow: hidden;

    }

    .stripe-ball::before {

      content: '';

      position: absolute;

      top: 20%;

      bottom: 20%;

      left: 0;

      right: 0;

      background: var(--stripe-color);

    }

    .stripe-text {

      position: relative;

      z-index: 10;

      background: white;

      border-radius: 50%;

      width: 18px;

      height: 18px;

      display: flex;

      align-items: center;

      justify-content: center;

      font-size: 10px;

      font-weight: bold;

      color: black;

    }

  </style>

</head>

<body>

  <div id="root"></div>



  <!-- Firebase åˆå§‹åŒ–ï¼šå·²ä¿®æ­£ï¼Œæ”¯æ´ Canvas ç’°å¢ƒå’Œå¤–éƒ¨è¨—ç®¡ç’°å¢ƒ (å¦‚ GitHub Pages) -->

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



    // --- ã€é‡è¦ã€‘å¤–éƒ¨ç’°å¢ƒé…ç½®ä½”ä½ç¬¦ ---

    // *** å¦‚æœæ‚¨åœ¨ Canvas ä¹‹å¤–é‹è¡Œ (ä¾‹å¦‚ GitHub Pages)ï¼Œè«‹å°‡ä»¥ä¸‹å€¼æ›¿æ›ç‚ºæ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½®ï¼ ***

    const EXTERNAL_FIREBASE_CONFIG = {

      apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0", // <-- è«‹å‹™å¿…æ›¿æ›æˆæ‚¨çš„ apiKey

      authDomain: "poolpokergame-b88ed.firebaseapp.com",

      projectId: "poolpokergame-b88ed", // <-- è«‹å‹™å¿…æ›¿æ›æˆæ‚¨çš„ projectId

      storageBucket: "ppoolpokergame-b88ed.appspot.com",

      messagingSenderId: "574863840102",

      appId: "1:574863840102:web:14368aaf84b3640c6eeea7"

    };



    // åµæ¸¬ç’°å¢ƒï¼šæª¢æŸ¥ Canvas å°ˆå±¬å…¨åŸŸè®Šæ•¸æ˜¯å¦å­˜åœ¨

    const isCanvasEnvironment = typeof __firebase_config !== 'undefined';

    

    // è¨­ç½®é…ç½®è®Šæ•¸

    let firebaseConfig;

    let initialAuthToken;

    let appId;



    if (isCanvasEnvironment) {

        // 1. Canvas ç’°å¢ƒï¼šä½¿ç”¨æ³¨å…¥çš„å…¨åŸŸè®Šæ•¸

        firebaseConfig = JSON.parse(__firebase_config);

        initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

    } else {

        // 2. å¤–éƒ¨ç’°å¢ƒ (å¦‚ GitHub Pages)ï¼šä½¿ç”¨æ‰‹å‹•é…ç½®

        firebaseConfig = EXTERNAL_FIREBASE_CONFIG;

        initialAuthToken = null;

        appId = firebaseConfig.projectId; 

        

        // å¤–éƒ¨ç’°å¢ƒé‹è¡Œæ™‚ï¼Œå¦‚æœä»æ˜¯é è¨­å€¼ï¼Œé¡¯ç¤ºè­¦å‘Š

        if (firebaseConfig.apiKey === "YOUR_API_KEY") {

             console.error("Firebase Initialization Error: Please update EXTERNAL_FIREBASE_CONFIG with your actual project keys for external hosting.");

             // æ‡‰ç”¨ç¨‹å¼å°‡ä½¿ç”¨åŒ¿åç™»å…¥ï¼Œä½†ä¸æœƒé€£ç·šåˆ°è³‡æ–™åº«

        }

    }

    

    // æ ¹æ“š Firestore å®‰å…¨è¦å‰‡è¨­å®šå…¬å…±è³‡æ–™è·¯å¾‘

    // è·¯å¾‘çµæ§‹ï¼š/artifacts/{appId}/public/data/pool_poker_rooms/main_room

    window.GAME_ROOM_PATH = `artifacts/${appId}/public/data/pool_poker_rooms/main_room`; 



    // --- Firebase Initialization ---

    const app = initializeApp(firebaseConfig);

    

    // è¨­ç½®å…¨åŸŸè®Šæ•¸ä¾› React å…ƒä»¶ä½¿ç”¨

    window.auth = getAuth(app); 

    window.db = getFirestore(app);

    window.doc = doc;

    window.onSnapshot = onSnapshot;

    window.setDoc = setDoc;

    window.updateDoc = updateDoc;

    window.onAuthStateChanged = onAuthStateChanged; 

    

    setLogLevel('debug'); // å•Ÿç”¨ debug log

    

    // åŸ·è¡Œèªè­‰ï¼šå„ªå…ˆä½¿ç”¨è‡ªå®šç¾© Tokenï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨åŒ¿åç™»å…¥

    const authPromise = (async () => {

        try {

            if (initialAuthToken) {

                // Canvas ç’°å¢ƒä½¿ç”¨ Custom Token

                await signInWithCustomToken(window.auth, initialAuthToken);

            } else {

                // å¤–éƒ¨ç’°å¢ƒæˆ–ç„¡ Token æ™‚ä½¿ç”¨åŒ¿åç™»å…¥

                await signInAnonymously(window.auth); 

            }

            console.log("Firebase Auth success.");

        } catch (error) {

            console.error("Firebase Auth Failed:", error);

            // éŒ¯èª¤å°‡åœ¨ React å…ƒä»¶ä¸­è™•ç†ä¸¦é¡¯ç¤ºçµ¦ä½¿ç”¨è€…

        }

    })();

  </script>



  <!-- React æ‡‰ç”¨ç¨‹å¼ - type="text/babel" -->

  <script type="text/babel">

    // å¾ window è§£æ§‹ Firebase å‡½æ•¸å’Œè®Šæ•¸

    const { 

        auth, db, doc, onSnapshot, setDoc, updateDoc, 

        onAuthStateChanged, GAME_ROOM_PATH 

    } = window;

    

    const App = () => {

      const [user, setUser] = React.useState(null);

      const [gameState, setGameState] = React.useState(null);

      const [nickname, setNickname] = React.useState('');

      const [loading, setLoading] = React.useState(true);

      const [errorMsg, setErrorMsg] = React.useState('');



      // --- Authentication & Data Sync ---

      React.useEffect(() => {

        const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {

          setUser(currentUser);

          // åœ¨é¦–æ¬¡èªè­‰ç‹€æ…‹ç¢ºå®šå¾Œï¼Œè§£é™¤ loading ç‹€æ…‹

          setLoading(false);

        }, (error) => {

            console.error("Auth Error:", error);

            setErrorMsg("èº«ä»½é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ– Firebase è¨­å®šã€‚");

            setLoading(false);

        });

        return () => unsubscribeAuth();

      }, []);



      // --- Firestore Listener ---

      React.useEffect(() => {

        // ç¢ºä¿ user å·²ç¶“è¢«è¨­ç½®ä¸” loading çµæŸ

        if (!user || loading) return; 



        // GAME_ROOM_PATH ç¾åœ¨æŒ‡å‘ä¸€å€‹æ–‡ä»¶ (e.g., .../pool_poker_rooms/main_room)

        const gameDocRef = doc(db, GAME_ROOM_PATH);



        const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {

          if (docSnap.exists()) {

            setGameState(docSnap.data());

          } else {

            setGameState(null); // Room doesn't exist yet

          }

          if(errorMsg.includes("é€£ç·šéŒ¯èª¤")) setErrorMsg(""); 

        }, (error) => {

          console.error("Snapshot error:", error);

          setErrorMsg("é€£ç·šéŒ¯èª¤ï¼šè«‹ç¢ºèªæ‚¨çš„ Firebase è¨­å®šå·²æ­£ç¢ºå¡«å…¥ï¼Œä¸” Firestore è¦å‰‡å·²ç™¼å¸ƒä»¥å…è¨±åŒ¿åä½¿ç”¨è€…è®€å¯«æ­¤è·¯å¾‘ã€‚");

          setLoading(false); 

        });



        return () => unsubscribe();

      }, [user, loading]);



      // --- Game Actions (Logic is unchanged) ---



      const handleJoin = async () => {

        if (!nickname.trim()) {

          setErrorMsg("è«‹è¼¸å…¥æš±ç¨±");

          return;

        }



        const gameDocRef = doc(db, GAME_ROOM_PATH);

        const myId = user.uid;

        

        try {

          if (!gameState) {

            // Create new game

            await setDoc(gameDocRef, {

              creatorId: myId,

              totalPlayers: 2,

              gameStarted: false,

              cardsPerPlayer: 5,

              players: {

                [myId]: {

                  id: myId,

                  nickname: nickname.trim(),

                  cards: [],

                  marked: []

                }

              },

              lastUpdated: new Date().toISOString()

            });

          } else {

            // Join existing

            if (Object.keys(gameState.players || {}).length >= 5) {

              setErrorMsg("æˆ¿é–“å·²æ»¿ (ä¸Šé™ 5 äºº)ï¼");

              return;

            }

            

            const updatedPlayers = {

              ...gameState.players,

              [myId]: {

                id: myId,

                nickname: nickname.trim(),

                cards: [],

                marked: []

              }

            };



            await updateDoc(gameDocRef, { players: updatedPlayers });

          }

          setErrorMsg("");

        } catch (e) {

          console.error("Join failed:", e);

          setErrorMsg("åŠ å…¥éŠæˆ²å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥ Firebase Console ä¸Šçš„éŒ¯èª¤è³‡è¨Šã€‚");

        }

      };



      const handleStartGame = async () => {

        if (gameState.creatorId !== user.uid) {

             setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ä»¥ç™¼ç‰Œï¼");

             return;

        }

        

        const playerIds = Object.keys(gameState.players);

        if (playerIds.length === 0) return;



        let deck = [];

        for (let i = 1; i <= 13; i++) {

          deck.push(i, i, i, i);

        }

        deck = deck.sort(() => Math.random() - 0.5);



        const newPlayers = { ...gameState.players };

        const cardsPerPlayer = gameState.cardsPerPlayer || 5;



        playerIds.forEach((pid, index) => {

          newPlayers[pid] = {

            ...newPlayers[pid],

            cards: deck.slice(index * cardsPerPlayer, (index + 1) * cardsPerPlayer), 

            marked: []

          };

        });



        const gameDocRef = doc(db, GAME_ROOM_PATH);

        await updateDoc(gameDocRef, {

          players: newPlayers,

          gameStarted: true,

          notice: 'éŠæˆ²é–‹å§‹ï¼'

        });

      };



      const handleRestart = async () => {

        if (gameState.creatorId !== user.uid) {

             setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ä»¥é‡é–‹ï¼");

             return;

        }



        const emptyPlayers = {};

        Object.keys(gameState.players).forEach(pid => {

          emptyPlayers[pid] = {

            ...gameState.players[pid],

            cards: [],

            marked: []

          };

        });



        const gameDocRef = doc(db, GAME_ROOM_PATH);

        await updateDoc(gameDocRef, {

          players: emptyPlayers,

          gameStarted: false,

          notice: 'å·²é‡æ–°é–‹å±€'

        });

      };



      const handleMarkNumber = async (num) => {

        if (!gameState?.gameStarted) {

            setErrorMsg("éŠæˆ²å°šæœªé–‹å§‹ã€‚");

            return;

        }

        

        const myId = user.uid;

        const myData = gameState.players[myId];

        if (!myData) return; 

        

        if (myData.marked.includes(num)) return; 



        const newMarked = [...myData.marked, num];

        const gameDocRef = doc(db, GAME_ROOM_PATH);

        

        await updateDoc(gameDocRef, {

          [`players.${myId}.marked`]: newMarked,

          notice: `${myData.nickname} æ¨™è¨˜äº† ${num} è™Ÿçƒ`

        });

      };



      // --- Helper: Ball Colors (Unchanged) ---

      const getBallStyle = (num) => {

        const colors = {

          1: 'yellow', 2: 'blue', 3: 'red', 4: 'purple', 5: 'orange', 6: 'green', 7: 'brown', 8: 'black',

          9: 'yellow', 10: 'blue', 11: 'red', 12: 'purple', 13: 'orange'

        };

        const color = colors[num] || 'gray';

        const isStripe = num > 8;

        

        return { color, isStripe };

      };



      // --- Render Components (Unchanged) ---



      if (loading || !user) {

         return (

            <div className="h-screen flex flex-col items-center justify-center p-4">

               {errorMsg && (

                   <div className="bg-red-500/20 text-red-300 p-4 rounded mb-4 text-center max-w-sm">

                       é€£ç·šç™¼ç”Ÿè‡´å‘½éŒ¯èª¤ï¼š{errorMsg}

                       <div className="text-xs mt-2 text-red-400">è«‹ç¢ºèªæ‚¨å·²åœ¨åŸå§‹ç¢¼ä¸­å¡«å…¥ **æ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½®**ï¼Œä¸¦å…è¨±åŒ¿åç™»å…¥ã€‚</div>

                   </div>

               )}

               <div className="text-emerald-400 text-lg">æ­£åœ¨é€£æ¥ Firebase...</div>

            </div>

         );

      }



      const isJoined = gameState && gameState.players && gameState.players[user.uid];



      if (!isJoined) {

        return (

          <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">

            <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-700">

              <h1 className="text-3xl font-bold text-emerald-400 mb-6 text-center flex items-center justify-center gap-2">

                ğŸ± Pool Poker æ’çƒæ’²å…‹

              </h1>

              {errorMsg && <div className="bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm text-center">{errorMsg}</div>}

              

              <div className="space-y-4">

                <div>

                  <label className="block text-slate-400 text-sm mb-1">æš±ç¨±</label>

                  <input 

                    type="text" 

                    value={nickname}

                    onChange={(e) => setNickname(e.target.value)}

                    className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:outline-none focus:border-emerald-500 transition"

                    placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±"

                  />

                </div>

                <button 

                  onClick={handleJoin}

                  className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded transition shadow-lg shadow-emerald-900/50"

                >

                  {gameState ? "åŠ å…¥ç¾æœ‰éŠæˆ²" : "å»ºç«‹æ–°æˆ¿é–“"}

                </button>

              </div>

              

              <div className="mt-6 text-xs text-slate-500 text-center">

                {gameState ? 

                  `${Object.keys(gameState.players || {}).length} ä½ç©å®¶å·²åœ¨ç­‰å€™` : 

                  "æˆç‚ºç¬¬ä¸€å€‹é–‹æ¡Œçš„äººï¼"

                }

              </div>

            </div>

          </div>

        );

      }



      // GAME BOARD

      const isCreator = gameState.creatorId === user.uid;



      return (

        <div className="min-h-screen bg-emerald-900 flex flex-col">

          {/* Header */}

          <div className="bg-emerald-950/80 p-4 shadow-md backdrop-blur-sm border-b border-emerald-800 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-50">

             <div className="flex items-center gap-2 mb-2 sm:mb-0">

                <span className="text-2xl">ğŸ±</span>

                <h1 className="font-bold text-white">Pool Poker</h1>

             </div>

             

             <div className="flex gap-2 text-sm">

               {isCreator && !gameState.gameStarted && (

                 <button onClick={handleStartGame} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded font-bold shadow-lg">

                   ç™¼ç‰Œé–‹å§‹éŠæˆ²

                 </button>

               )}

               {isCreator && (

                 <button onClick={handleRestart} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded shadow-lg">

                   é‡é–‹ä¸€å±€

                 </button>

               )}

             </div>

          </div>



          {/* Main Content */}

          <div className="flex-1 p-4 max-w-6xl mx-auto w-full flex flex-col gap-6">

            

            {/* Notification Area */}

            {(errorMsg || gameState.notice) && (

              <div className={`p-3 rounded shadow-lg text-center text-sm ${errorMsg ? 'bg-red-500/90 text-white animate-pulse' : 'bg-blue-500/20 text-blue-300'}`}>

                {errorMsg || gameState.notice}

              </div>

            )}

            {!gameState.gameStarted && (

               <div className="bg-emerald-800/50 p-4 rounded-lg border border-emerald-700 text-center text-emerald-200">

                 ç­‰å¾…æˆ¿ä¸»ç™¼ç‰Œ... (ç›®å‰ {Object.keys(gameState.players).length} ä½ç©å®¶)

               </div>

            )}



            {/* Ball Selection Area */}

            {gameState.gameStarted && (

              <div className="bg-emerald-950/40 p-6 rounded-3xl border-[12px] border-amber-900 shadow-2xl relative">

                {/* Pockets visual (è£é£¾ç”¨) */}

                <div className="absolute top-0 left-0 w-8 h-8 bg-black rounded-br-full"></div>

                <div className="absolute top-0 right-0 w-8 h-8 bg-black rounded-bl-full"></div>

                <div className="absolute bottom-0 left-0 w-8 h-8 bg-black rounded-tr-full"></div>

                <div className="absolute bottom-0 right-0 w-8 h-8 bg-black rounded-tl-full"></div>

                

                <h2 className="text-center text-emerald-200/50 text-sm mb-4 font-mono uppercase tracking-widest">é»æ“Šä»¥æ¨™è¨˜æ“Šè½çš„çƒ (1-13)</h2>

                

                <div className="flex flex-wrap justify-center gap-3 sm:gap-4">

                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13].map((num) => {

                    const { color, isStripe } = getBallStyle(num);

                    const isMarked = gameState.players[user.uid]?.marked.includes(num);

                    

                    return (

                      <button

                        key={num}

                        onClick={() => handleMarkNumber(num)}

                        disabled={isMarked}

                        title={isMarked ? `å·²æ¨™è¨˜ ${num} è™Ÿçƒ` : `é»æ“Šæ¨™è¨˜ ${num} è™Ÿçƒ`}

                        className={`

                          w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center font-bold text-sm shadow-xl transition-transform active:scale-95

                          ${isMarked ? 'opacity-30 grayscale cursor-not-allowed scale-90' : 'hover:scale-110'}

                          ${isStripe ? 'stripe-ball' : 'ball'}

                        `}

                        style={{

                          backgroundColor: isStripe ? 'white' : color,

                          '--stripe-color': color,

                          color: isStripe ? 'black' : (num === 8 ? 'white' : 'white')

                        }}

                      >

                         <span className={isStripe ? 'stripe-text' : ''}>{num}</span>

                      </button>

                    );

                  })}

                </div>

              </div>

            )}



            {/* Players Hands */}

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

              {Object.values(gameState.players).sort((a,b) => a.id === user.uid ? -1 : 1).map((player) => {

                const isMe = player.id === user.uid;

                

                return (

                  <div key={player.id} className={`

                    relative p-4 rounded-xl border-2 transition-all duration-300

                    ${isMe ? 'bg-emerald-800 border-emerald-400 shadow-lg scale-[1.02]' : 'bg-emerald-900/60 border-emerald-800'}

                  `}>

                    <div className="flex justify-between items-center mb-3">

                      <div className="flex items-center gap-2">

                        <div className={`w-3 h-3 rounded-full ${isMe ? 'bg-green-400' : 'bg-slate-500'}`}></div>

                        <span className={`font-bold ${isMe ? 'text-white' : 'text-emerald-200'}`}>

                          {player.nickname} {isMe && '(æ‚¨)'}

                        </span>

                      </div>

                      <span className="text-xs text-emerald-400 font-mono">

                        å·²æ“Šè½ {player.marked?.length || 0} å€‹ç›®æ¨™

                      </span>

                    </div>



                    <div className="flex flex-wrap gap-2 min-h-[60px]">

                      {gameState.gameStarted && player.cards && player.cards.map((card, idx) => {

                        const isMarked = player.marked.includes(card);

                        const isVisible = isMe || isMarked;

                        

                        return (

                          <div 

                            key={`${player.id}-${idx}`}

                            className={`

                              w-10 h-14 sm:w-12 sm:h-16 rounded flex items-center justify-center text-lg font-bold shadow-sm transition-all duration-500

                              ${!isVisible 

                                ? 'bg-emerald-700 border border-emerald-600 opacity-80' 

                                : isMarked 

                                  ? 'bg-yellow-400 text-black border-2 border-yellow-200 scale-105 shadow-yellow-500/50' 

                                  : 'bg-white text-slate-800' 

                              }

                            `}

                          >

                             {isVisible ? card : ''}

                          </div>

                        );

                      })}

                      

                      {gameState.gameStarted && (!player.cards || player.cards.length === 0) && (

                        <div className="text-sm text-emerald-500 italic w-full text-center py-2">å°šæœªç™¼ç‰Œ</div>

                      )}

                      

                      {!gameState.gameStarted && (

                        <div className="text-sm text-emerald-500 italic w-full text-center py-2">ç­‰å¾…ä¸­...</div>

                      )}

                    </div>

                  </div>

                );

              })}

            </div>



          </div>

        </div>

      );

    };



    const root = ReactDOM.createRoot(document.getElementById('root'));

    root.render(<App />);

  </script>

</body>

</html>

