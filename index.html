<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>井字連線遊戲</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .board-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .board-cell:hover:not(.occupied) {
            background-color: #f0f4f8;
        }
        .occupied {
            cursor: default;
        }
        .symbol-x {
            color: #ef4444; /* Red 500 */
        }
        .symbol-o {
            color: #3b82f6; /* Blue 500 */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div id="app" class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center border-b pb-3 mb-4">
            即時多人井字遊戲
        </h1>

        <!-- 身份驗證區塊 -->
        <div id="auth-status" class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg" role="alert">
            <p id="connection-message" class="font-bold">正在驗證連線...</p>
            <p id="user-id-display" class="text-sm break-all mt-1"></p>
        </div>

        <!-- 遊戲操作區塊 -->
        <div id="game-controls" class="space-y-4">
            <button id="create-game-btn" onclick="createGame()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                創建新遊戲 (你的符號是 X)
            </button>
            <div class="flex items-center space-x-2">
                <input type="text" id="game-id-input" placeholder="輸入遊戲 ID" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                <button id="join-game-btn" onclick="joinGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    加入遊戲
                </button>
            </div>
            <p id="current-game-id" class="text-center text-sm font-medium text-gray-600 hidden">
                當前遊戲 ID: <span class="font-mono text-indigo-700 text-base" id="display-game-id"></span>
            </p>
        </div>

        <!-- 遊戲狀態區塊 -->
        <div id="game-info" class="text-center p-3 bg-yellow-100 text-yellow-800 rounded-lg shadow-inner hidden">
            <p id="player-role" class="font-bold text-lg mb-1"></p>
            <p id="game-status" class="text-xl font-extrabold"></p>
        </div>

        <!-- 遊戲棋盤區塊 -->
        <div id="game-board-container" class="mt-6 hidden">
            <div id="game-board" class="grid grid-cols-3 grid-rows-3 gap-2 aspect-square p-2 bg-gray-200 rounded-xl shadow-inner">
                <!-- Cell content will be generated here -->
            </div>
        </div>

        <!-- 錯誤或提示訊息 -->
        <div id="message-box" class="mt-4 p-3 text-sm text-red-700 bg-red-100 border border-red-200 rounded-lg hidden"></div>
    </div>

    <!-- Firebase SDK 引入 -->
    <script type="module">
        // 1. Firebase 服務和工具導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設置日誌級別為 Debug 以便調試
        setLogLevel('Debug');

        // 2. 全域變量與 Firebase 初始化
        let app;
        let db;
        let auth;
        let userId = null;
        let userSymbol = null; // 'X' or 'O'
        let currentGameId = null;
        let unsubscribe = null; // 用於儲存 onSnapshot 的取消訂閱函數

        // 從環境變量獲取配置
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 應用程式 DOM 元素
        const connMessageEl = document.getElementById('connection-message');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const createBtn = document.getElementById('create-game-btn');
        const joinBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const boardEl = document.getElementById('game-board');
        const gameInfoEl = document.getElementById('game-info');
        const playerRoleEl = document.getElementById('player-role');
        const gameStatusEl = document.getElementById('game-status');
        const boardContainerEl = document.getElementById('game-board-container');
        const messageBoxEl = document.getElementById('message-box');
        const currentGameIdEl = document.getElementById('current-game-id');
        const displayGameIdEl = document.getElementById('display-game-id');


        // 顯示錯誤訊息
        function showMessage(msg, isError = true) {
            messageBoxEl.textContent = msg;
            messageBoxEl.classList.remove('hidden', 'text-green-700', 'bg-green-100', 'text-red-700', 'bg-red-100', 'border-red-200', 'border-green-200');
            messageBoxEl.classList.add(isError ? 'text-red-700' : 'text-green-700', isError ? 'bg-red-100' : 'bg-green-100', isError ? 'border-red-200' : 'border-green-200');
            messageBoxEl.classList.remove('hidden');
        }

        // 隱藏訊息
        function hideMessage() {
            messageBoxEl.classList.add('hidden');
        }

        // 渲染遊戲棋盤
        function renderBoard(gameData) {
            boardEl.innerHTML = ''; // 清空棋盤
            
            // 檢查是否所有必要的元素都已加載
            if (!gameData || !gameData.board) {
                boardEl.innerHTML = '<div class="col-span-3 text-center text-gray-500">等待遊戲數據...</div>';
                return;
            }

            gameData.board.forEach((cell, index) => {
                const cellEl = document.createElement('div');
                cellEl.className = `board-cell ${cell ? 'occupied' : ''}`;
                cellEl.dataset.index = index;
                cellEl.innerHTML = cell ? `<span class="symbol-${cell.toLowerCase()}">${cell}</span>` : '';

                const isMyTurn = gameData.currentPlayer === userSymbol;
                const canMove = !cell && isMyTurn && gameData.status === '進行中';

                if (canMove) {
                    cellEl.onclick = () => window.makeMove(index);
                } else if (!cell && gameData.status === '進行中' && !isMyTurn) {
                    // 提示非當前玩家的回合
                    cellEl.style.cursor = 'wait';
                }

                boardEl.appendChild(cellEl);
            });
        }

        // 監聽遊戲狀態更新並更新 UI
        function handleGameUpdate(gameData) {
            if (!gameData) return;

            // 1. 渲染棋盤
            renderBoard(gameData);

            // 2. 更新遊戲資訊區塊
            gameInfoEl.classList.remove('hidden');

            // 設置玩家角色
            playerRoleEl.textContent = `你是 ${userSymbol}`;
            playerRoleEl.classList.remove('text-red-500', 'text-blue-500');
            playerRoleEl.classList.add(userSymbol === 'X' ? 'text-red-500' : 'text-blue-500');


            // 設置遊戲狀態
            let statusText = '';
            let statusClasses = 'font-extrabold';

            if (gameData.status === '進行中') {
                const isMyTurn = gameData.currentPlayer === userSymbol;
                statusText = isMyTurn ? '輪到你 (點擊方格)' : `輪到 ${gameData.currentPlayer} (等待中)`;
                statusClasses += isMyTurn ? ' text-green-600' : ' text-gray-600';
            } else if (gameData.status === '平局') {
                statusText = '遊戲結束：平局！';
                statusClasses += ' text-purple-600';
            } else if (gameData.status === 'X 獲勝' || gameData.status === 'O 獲勝') {
                statusText = `遊戲結束: ${gameData.status}!`;
                statusClasses += ' text-red-600';
            } else if (gameData.status === '等待玩家') {
                 // 檢查玩家是否只有一人
                const players = gameData.players || {};
                const playerCount = Object.keys(players).length;

                if (playerCount === 1) {
                    statusText = '等待另一位玩家加入...';
                    statusClasses += ' text-orange-600';
                } else {
                    statusText = '遊戲已準備好開始！';
                    statusClasses += ' text-green-600';
                }
            }

            gameStatusEl.textContent = statusText;
            gameStatusEl.className = statusClasses;
        }

        // 3. Firebase 初始化和身份驗證
        async function initFirebase() {
            if (!firebaseConfig) {
                connMessageEl.textContent = '錯誤: Firebase 配置未定義。';
                connMessageEl.classList.replace('bg-indigo-100', 'bg-red-100');
                connMessageEl.classList.replace('border-indigo-500', 'border-red-500');
                connMessageEl.classList.replace('text-indigo-700', 'text-red-700');
                return;
            }

            try {
                // 初始化 Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; // 設置全域可訪問，供 makeMove 使用

                // 處理身份驗證
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // 如果沒有提供 token，則匿名登入
                    await signInAnonymously(auth);
                }

                // 設置身份驗證狀態監聽器
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        connMessageEl.textContent = '✅ 已連線 (身份驗證完成)';
                        connMessageEl.classList.replace('bg-indigo-100', 'bg-green-100');
                        connMessageEl.classList.replace('border-indigo-500', 'border-green-500');
                        connMessageEl.classList.replace('text-indigo-700', 'text-green-700');
                        userIdDisplayEl.textContent = `你的 User ID (分享給其他人): ${userId}`;
                        
                        // 啟用遊戲控制
                        createBtn.disabled = false;
                        joinBtn.disabled = false;

                        console.log('User authenticated with ID:', userId);
                    } else {
                        // 雖然我們強制匿名登入，但以防萬一
                        connMessageEl.textContent = '❌ 連線錯誤: 請嘗試重新整理';
                        connMessageEl.classList.replace('bg-indigo-100', 'bg-red-100');
                        connMessageEl.classList.replace('border-indigo-500', 'border-red-500');
                        connMessageEl.classList.replace('text-indigo-700', 'text-red-700');
                        userId = null;
                        createBtn.disabled = true;
                        joinBtn.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Authentication Error:", error);
                connMessageEl.textContent = `❌ 連線失敗: ${error.message}`;
                connMessageEl.classList.replace('bg-indigo-100', 'bg-red-100');
                connMessageEl.classList.replace('border-indigo-500', 'border-red-500');
                connMessageEl.classList.replace('text-indigo-700', 'text-red-700');
            }
        }
        
        // 4. 遊戲功能

        // 檢查勝利條件
        function checkWin(board) {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6], // diagonals
            ];

            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a]; // 返回獲勝者的符號 ('X' or 'O')
                }
            }
            return null;
        }

        // 檢查平局
        function checkDraw(board) {
            return !checkWin(board) && board.every(cell => cell !== null);
        }

        // 開始監聽 Firestore 上的特定遊戲
        function startListeningToGame(gameId) {
            if (unsubscribe) {
                unsubscribe(); // 停止舊的監聽
            }
            
            currentGameId = gameId;
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'tictactoe', gameId);
            
            // 顯示遊戲 ID
            displayGameIdEl.textContent = gameId;
            currentGameIdEl.classList.remove('hidden');
            boardContainerEl.classList.remove('hidden');
            hideMessage();

            unsubscribe = onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    handleGameUpdate(gameData);
                } else {
                    showMessage('遊戲不存在或已結束。', true);
                    resetGameState();
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                showMessage(`資料庫錯誤: ${error.message}`, true);
                resetGameState();
            });
        }

        // 重置本地遊戲狀態
        function resetGameState() {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            currentGameId = null;
            userSymbol = null;
            currentGameIdEl.classList.add('hidden');
            boardContainerEl.classList.add('hidden');
            gameInfoEl.classList.add('hidden');
            renderBoard({ board: Array(9).fill(null) });
        }
        
        // 創建新遊戲 (X 玩家)
        window.createGame = async function() {
            if (!userId) {
                showMessage('請等待身份驗證完成。', true);
                return;
            }
            
            try {
                // 創建一個新的遊戲 ID (使用 UUID 或時間戳組合)
                const newGameId = `game-${Date.now().toString(36).toUpperCase()}`; 
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'tictactoe', newGameId);
                
                // 初始遊戲狀態
                const initialData = {
                    board: Array(9).fill(null), // 9個單元的棋盤
                    currentPlayer: 'X',
                    status: '等待玩家',
                    players: {
                        'X': userId,
                    },
                    createdAt: new Date().getTime(),
                };

                await setDoc(gameRef, initialData);
                
                // 設置為 X 玩家並開始監聽
                userSymbol = 'X';
                startListeningToGame(newGameId);
                showMessage(`✅ 遊戲 [${newGameId}] 創建成功！分享此 ID 給朋友`, false);

            } catch (error) {
                console.error("Error creating game:", error);
                showMessage(`創建遊戲失敗: ${error.message}`, true);
            }
        }

        // 加入現有遊戲 (O 玩家)
        window.joinGame = async function() {
            if (!userId) {
                showMessage('請等待身份驗證完成。', true);
                return;
            }

            const gameId = gameIdInput.value.trim().toUpperCase();
            if (!gameId) {
                showMessage('請輸入有效的遊戲 ID。', true);
                return;
            }
            
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'tictactoe', gameId);

            try {
                // 使用交易確保原子性 (避免多個用戶同時加入)
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);

                    if (!gameDoc.exists()) {
                        throw new Error("遊戲 ID 不存在。");
                    }

                    const gameData = gameDoc.data();
                    const players = gameData.players || {};

                    if (players['X'] && players['O']) {
                        throw new Error("遊戲已滿，無法加入。");
                    }
                    
                    if (players['X'] === userId || players['O'] === userId) {
                        // 已經在遊戲中，直接開始監聽
                        userSymbol = players['X'] === userId ? 'X' : 'O';
                        return;
                    }

                    if (!players['X']) {
                        // 理論上不應該發生，但以防萬一
                        players['X'] = userId;
                        userSymbol = 'X';
                    } else {
                        // 加入 O 玩家
                        players['O'] = userId;
                        userSymbol = 'O';
                        gameData.status = '進行中'; // 兩個玩家到齊，遊戲開始
                    }

                    gameData.players = players;
                    transaction.update(gameRef, gameData);
                });
                
                startListeningToGame(gameId);
                showMessage(`✅ 成功加入遊戲 [${gameId}]！你的符號是 ${userSymbol}`, false);

            } catch (error) {
                console.error("Error joining game:", error);
                showMessage(`加入遊戲失敗: ${error.message}`, true);
            }
        }

        // 進行移動
        window.makeMove = async function(index) {
            if (!currentGameId || !userSymbol || !userId) {
                showMessage('未加入遊戲，請先創建或加入遊戲。', true);
                return;
            }

            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'tictactoe', currentGameId);

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    const gameData = gameDoc.data();

                    if (gameData.status !== '進行中') {
                        throw new Error("遊戲已結束或尚未開始。");
                    }

                    if (gameData.currentPlayer !== userSymbol) {
                        throw new Error("現在不是你的回合。");
                    }

                    if (gameData.board[index] !== null) {
                        throw new Error("此方格已被佔用。");
                    }
                    
                    // 1. 更新棋盤
                    const newBoard = [...gameData.board];
                    newBoard[index] = userSymbol;
                    gameData.board = newBoard;

                    // 2. 檢查獲勝/平局
                    const winner = checkWin(newBoard);
                    
                    if (winner) {
                        gameData.status = `${winner} 獲勝`;
                    } else if (checkDraw(newBoard)) {
                        gameData.status = '平局';
                    } else {
                        // 3. 切換玩家
                        gameData.currentPlayer = userSymbol === 'X' ? 'O' : 'X';
                    }

                    transaction.update(gameRef, gameData);
                });

            } catch (error) {
                console.error("Error making move:", error);
                // 只有在不是 "現在不是你的回合" 的情況下才顯示為錯誤
                if (error.message !== "現在不是你的回合。") {
                    showMessage(`移動失敗: ${error.message}`, true);
                } else {
                    // 如果只是單純不是回合，不顯示錯誤，避免干擾
                }
            }
        }

        // 5. 啟動應用程式
        window.onload = initFirebase;
    </script>
</body>
</html>
