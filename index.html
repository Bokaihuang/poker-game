<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚å‚™å¿˜éŒ„ (é€£ç·šä¿®å¾©èˆ‡å¼·åŒ–æ—¥èªŒç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .container-card {
            max-width: 600px;
            width: 100%;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">

    <div id="app-container" class="container-card bg-white p-6 md:p-10 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center border-b-4 border-indigo-500 pb-3 mb-6">
            âœ¨ å³æ™‚å‚™å¿˜éŒ„ (To-Do List)
        </h1>

        <!-- é€£ç·šç‹€æ…‹é¡¯ç¤ºå€å¡Š -->
        <div id="status-box" class="p-3 rounded-lg shadow-inner text-sm transition duration-300 bg-yellow-100">
            <p id="connection-message" class="font-bold text-gray-700">æ­£åœ¨åˆå§‹åŒ–é€£ç·š...</p>
            <p id="user-id-display" class="text-xs text-gray-500 break-all mt-1 hidden">ä½¿ç”¨è€… ID: </p>
        </div>
        
        <!-- è¼¸å…¥å’Œæ–°å¢å‚™å¿˜éŒ„å€å¡Š -->
        <div id="input-area" class="flex space-x-3 pt-4 border-t border-gray-100 opacity-50 pointer-events-none transition duration-300">
            <input type="text" id="new-todo-input" placeholder="æ–°å¢ä¸€é …å‚™å¿˜éŒ„..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
            <button id="add-todo-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-150 ease-in-out">
                æ–°å¢
            </button>
        </div>

        <!-- å‚™å¿˜éŒ„åˆ—è¡¨å€å¡Š -->
        <div class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">æˆ‘çš„å‚™å¿˜éŒ„æ¸…å–® (å…¬é–‹åˆ—è¡¨)</h2>
            <ul id="todo-list" class="space-y-3">
                <li class="p-4 bg-gray-50 text-gray-500 rounded-lg border border-gray-200 text-center italic">
                    é€£ç·šæˆåŠŸå¾Œå°‡æœƒè¼‰å…¥å‚™å¿˜éŒ„...
                </li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK å’Œä¸»è¦æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        // 1. Firebase æœå‹™å’Œå·¥å…·å°å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            collection, 
            query, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ç‚º Debug
        setLogLevel('Debug');

        // =================================================================================
        // ğŸš¨ æ‚¨çš„å¯¦éš› Firebase é…ç½®å·²æ’å…¥æ–¼æ­¤ï¼š
        // =================================================================================
        const USER_PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0", 
            authDomain: "poolpokergame-b88ed.firebaseapp.com",
            projectId: "poolpokergame-b88ed", 
            storageBucket: "poolpokergame-b88ed.appspot.com",
            messagingSenderId: "574863840102",
            appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
        };
        // =================================================================================


        // 3. å…¨åŸŸè®Šé‡ã€é…ç½®å’Œ DOM å…ƒç´ 
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        
        // ç’°å¢ƒè®Šé‡æª¢æŸ¥å’Œé…ç½®æ±ºå®š
        const isInCanvas = typeof __firebase_config !== 'undefined';
        
        let firebaseConfig;
        
        if (isInCanvas) {
            // å¦‚æœåœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼Œå„ªå…ˆä½¿ç”¨è‡ªå‹•æ³¨å…¥çš„é…ç½®
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // å¦å‰‡ï¼Œä½¿ç”¨æ‚¨æ‰‹å‹•æä¾›çš„é…ç½®ä½œç‚º fallback
            firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
        }

        // App ID æ±ºå®š (ç”¨æ–¼ Firestore è·¯å¾‘)
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-todo-app';
        
        // Canvas å°ˆç”¨çš„è‡ªè¨‚èªè­‰ Token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // DOM å…ƒç´ å¿«å–
        const connMessageEl = document.getElementById('connection-message');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const statusBoxEl = document.getElementById('status-box');
        const inputAreaEl = document.getElementById('input-area');
        const inputEl = document.getElementById('new-todo-input');
        const addBtn = document.getElementById('add-todo-btn');
        const todoListEl = document.getElementById('todo-list');

        
        // 4. UI/ç‹€æ…‹ç®¡ç†å‡½æ•¸
        
        /**
         * æ›´æ–°é€£ç·šç‹€æ…‹ UI
         */
        function updateStatus(msg, isSuccess) {
            connMessageEl.textContent = msg;
            statusBoxEl.classList.remove('bg-red-100', 'bg-green-100', 'bg-yellow-100');
            
            if (isSuccess) {
                statusBoxEl.classList.add('bg-green-100');
            } else if (msg.includes('éŒ¯èª¤') || msg.includes('å¤±æ•—') || msg.includes('ç„¡æ³•')) {
                statusBoxEl.classList.add('bg-red-100');
            } else {
                statusBoxEl.classList.add('bg-yellow-100');
            }
            
            if (isSuccess) {
                inputAreaEl.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                inputAreaEl.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        /** * é¡¯ç¤ºä½¿ç”¨è€… ID 
         */
        function displayUserId() {
            if (userId) {
                userIdDisplayEl.textContent = `ä½¿ç”¨è€… ID (è«‹æä¾›çµ¦ä»–äººåˆ†äº«): ${userId}`;
                userIdDisplayEl.classList.remove('hidden');
            }
        }

        // 5. Firestore æ•¸æ“šæ“ä½œå‡½æ•¸
        
        /**
         * è™•ç†æ–°å¢å‚™å¿˜éŒ„
         */
        async function handleAddTodo() {
            const text = inputEl.value.trim();
            if (!text || !db || !userId) return;

            // å…¬é–‹è³‡æ–™è·¯å¾‘: /artifacts/{appId}/public/data/todos
            const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', 'todos');

            const newTodo = {
                text: text,
                timestamp: Date.now(),
                userId: userId, 
                completed: false
            };

            try {
                await addDoc(collectionPath, newTodo);
                inputEl.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            } catch (error) {
                console.error("Error adding document: ", error);
                updateStatus(`âŒ æ–°å¢å‚™å¿˜éŒ„å¤±æ•—: ${error.message}`, false);
            }
        }
        
        /**
         * è™•ç†åˆªé™¤å‚™å¿˜éŒ„
         */
        async function handleDeleteTodo(docId) {
            if (!db) return;

            // ç¢ºä¿è·¯å¾‘èˆ‡æ–°å¢æ™‚ä¸€è‡´
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'todos', docId);

            try {
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                updateStatus(`âŒ åˆªé™¤å‚™å¿˜éŒ„å¤±æ•—: ${error.message}`, false);
            }
        }

        /**
         * æ¸²æŸ“å‚™å¿˜éŒ„åˆ—è¡¨
         */
        function renderTodos(todos) {
            if (todos.length === 0) {
                todoListEl.innerHTML = `
                    <li class="p-4 bg-gray-50 text-gray-500 rounded-lg border border-gray-200 text-center italic">
                        ç›®å‰æ²’æœ‰å‚™å¿˜éŒ„ï¼Œæ–°å¢ä¸€å€‹å§ï¼
                    </li>
                `;
                return;
            }

            // æ ¹æ“šæ™‚é–“æˆ³é™åºæ’åº (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            todos.sort((a, b) => b.timestamp - a.timestamp);

            todoListEl.innerHTML = '';
            
            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-md transition duration-200 hover:shadow-lg border-l-4 border-indigo-400';
                li.innerHTML = `
                    <span class="text-gray-800 text-lg">${todo.text}</span>
                    <button data-id="${todo.id}" class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                todoListEl.appendChild(li);
            });
            
            // ç‚ºæ–°æ¸²æŸ“çš„æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
            todoListEl.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => handleDeleteTodo(e.currentTarget.dataset.id);
            });
        }
        
        /**
         * è¨­ç½® Firestore æ•¸æ“šç›£è½å™¨ (onSnapshot)
         */
        function setupDataListener() {
            if (!isAuthReady || !db || !userId) return;

            updateStatus('ğŸŸ¢ èº«ä»½é©—è­‰æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥è³‡æ–™...', false);

            // å…¬é–‹è³‡æ–™è·¯å¾‘: /artifacts/{appId}/public/data/todos
            const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', 'todos');
            const q = query(collectionPath);
            
            // ä½¿ç”¨ onSnapshot é€²è¡Œå³æ™‚ç›£è½
            onSnapshot(q, (snapshot) => {
                const todos = [];
                snapshot.forEach((doc) => {
                    todos.push({ id: doc.id, ...doc.data() });
                });
                
                renderTodos(todos);
                updateStatus('âœ… é€£ç·šæˆåŠŸ & è³‡æ–™å³æ™‚åŒæ­¥ä¸­', true);
            }, (error) => {
                console.error("Firestore Listener Error: ", error);
                updateStatus(`âŒ è³‡æ–™åŒæ­¥å¤±æ•—: ${error.message}`, false);
            });
        }


        // 6. Firebase åˆå§‹åŒ–å’Œèº«ä»½é©—è­‰æµç¨‹
        async function initFirebase() {
            try {
                // åˆå§‹åŒ– Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                updateStatus('ğŸŸ¡ æ­£åœ¨å˜—è©¦èº«ä»½é©—è­‰...', false);

                // è™•ç†èº«ä»½é©—è­‰
                if (initialAuthToken) {
                    // Canvas ç’°å¢ƒçš„è‡ªè¨‚èªè­‰
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // å¤–éƒ¨ç’°å¢ƒä½¿ç”¨åŒ¿åç™»å…¥
                    await signInAnonymously(auth);
                }

                // è¨­ç½®èº«ä»½é©—è­‰ç‹€æ…‹ç›£è½å™¨
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        displayUserId();
                        
                        // è¨­ç½®æ•¸æ“šç›£è½å™¨ (åªæœ‰åœ¨æˆåŠŸç™»å…¥å¾Œæ‰é–‹å§‹)
                        setupDataListener();
                    } else {
                        // å¦‚æœ onAuthStateChanged ç›£è½å™¨å ±å‘Šä½¿ç”¨è€…ç™»å‡ºæˆ–ç™»å…¥å¤±æ•— (ä½†åœ¨ try/catch ä¸­æœªè¢«æ•ç²)
                        updateStatus('âŒ èº«ä»½é©—è­‰ç‹€æ…‹è®Šæ›´: ä½¿ç”¨è€…æœªç™»å…¥æˆ–ç™»å…¥å¤±æ•—', false);
                        userId = null;
                        isAuthReady = false;
                    }
                });
                
                // è¨­ç½®äº‹ä»¶ç›£è½å™¨
                addBtn.onclick = handleAddTodo;
                inputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleAddTodo();
                    }
                });

            } catch (error) {
                // æ•ç²ä¸¦é¡¯ç¤ºåˆå§‹åŒ–æˆ–èº«ä»½é©—è­‰éŒ¯èª¤
                console.error("ğŸ”¥ è‡´å‘½éŒ¯èª¤ï¼šFirebase èº«ä»½é©—è­‰å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„å°ˆæ¡ˆé…ç½®æˆ– API Key é™åˆ¶ã€‚", error);
                
                let errorMessage = `é€£ç·šå¤±æ•—ã€‚ä»£ç¢¼: ${error.code || 'æœªçŸ¥'}`;
                
                if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'ç„¡æ³•é€£ç·šåˆ° Firebase æœå‹™ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯æˆ– API Key é™åˆ¶ã€‚';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'Firebase Authentication æœå‹™æˆ–åŒ¿åç™»å…¥/è‡ªè¨‚ Token ç™»å…¥æœªåœ¨æ‚¨çš„å°ˆæ¡ˆä¸­å•Ÿç”¨ã€‚';
                } else if (error.code) {
                    errorMessage = `é©—è­‰å¤±æ•—ï¼š${error.code}`;
                }

                updateStatus(`âŒ ${errorMessage} (è©³æƒ…è«‹çœ‹ Console)`, false);
            }
        }

        // 7. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = initFirebase;
    </script>
</body>
</html>
