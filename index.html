<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool Poker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: white; }
    
    /* Pool Ball Styles */
    .ball {
      box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 2px 2px 5px rgba(0,0,0,0.3);
    }
    .stripe-ball {
      background: white;
      position: relative;
      overflow: hidden;
    }
    .stripe-ball::before {
      content: '';
      position: absolute;
      top: 20%;
      bottom: 20%;
      left: 0;
      right: 0;
      background: var(--stripe-color);
    }
    .stripe-text {
      position: relative;
      z-index: 10;
      background: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: black;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // -------------------------------------------------------------
    // IMPORTANT: This configuration is taken from your initial request 
    // and is now hardcoded for GitHub Pages deployment.
    // -------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0",
      authDomain: "poolpokergame-b88ed.firebaseapp.com",
      projectId: "poolpokergame-b88ed",
      storageBucket: "poolpokergame-b88ed.appspot.com",
      messagingSenderId: "574863840102",
      appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
    };
    
    // Hardcoded unique ID for the public room (since __app_id is unavailable)
    const PUBLIC_APP_ID = 'pool-poker-game-shared';

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // å•Ÿç”¨åŒ¿åç™»å…¥ï¼ˆé©ç”¨æ–¼å…¬é–‹ç¶²ç«™ï¼‰
    // è«‹æ³¨æ„ï¼Œæ‚¨éœ€è¦ç¢ºä¿æ‚¨çš„ Firestore Security Rules å…è¨±åŒ¿åè®€å¯«
    signInAnonymously(auth).catch(error => console.error("Anonymous Sign-in Failed:", error));
    // -------------------------------------------------------------

    const App = () => {
      const [user, setUser] = React.useState(null);
      const [gameState, setGameState] = React.useState(null);
      const [nickname, setNickname] = React.useState('');
      const [loading, setLoading] = React.useState(true);
      const [errorMsg, setErrorMsg] = React.useState('');

      // --- Authentication & Data Sync ---
      React.useEffect(() => {
        const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
          // åœ¨ GitHub Pages ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘åªåŸ·è¡Œä¸€æ¬¡åŒ¿åç™»å…¥
          setUser(currentUser);
          setLoading(false);
        });
        return () => unsubscribeAuth();
      }, []);

      // --- Firestore Listener ---
      React.useEffect(() => {
        if (!user) return;

        // ä½¿ç”¨ç¡¬å¼ç·¨ç¢¼çš„è·¯å¾‘ä¾†å­˜å–å…¬å…±è³‡æ–™
        const gameDocRef = doc(db, 'artifacts', PUBLIC_APP_ID, 'public', 'data', 'pool_poker_room');

        const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {
          if (docSnap.exists()) {
            setGameState(docSnap.data());
          } else {
            setGameState(null); // Room doesn't exist yet
          }
        }, (error) => {
          console.error("Snapshot error:", error);
          setErrorMsg("éŒ¯èª¤ï¼šç„¡æ³•åŒæ­¥éŠæˆ²è³‡æ–™ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Firestore Security Rules æ˜¯å¦å…è¨±åŒ¿åè®€å¯«ã€‚");
        });

        return () => unsubscribe();
      }, [user]);

      // --- Game Actions ---

      const handleJoin = async () => {
        if (!nickname.trim()) {
          setErrorMsg("è«‹è¼¸å…¥æš±ç¨±");
          return;
        }

        const gameDocRef = doc(db, 'artifacts', PUBLIC_APP_ID, 'public', 'data', 'pool_poker_room');
        const myId = user.uid;
        
        try {
          if (!gameState) {
            // Create new game
            await setDoc(gameDocRef, {
              creatorId: myId,
              totalPlayers: 2,
              gameStarted: false,
              cardsPerPlayer: 5,
              players: {
                [myId]: {
                  id: myId,
                  nickname: nickname.trim(),
                  cards: [],
                  marked: []
                }
              },
              lastUpdated: new Date().toISOString()
            });
          } else {
            // Join existing
            if (Object.keys(gameState.players || {}).length >= 5) {
              setErrorMsg("æˆ¿é–“å·²æ»¿ (ä¸Šé™ 5 äºº)ï¼");
              return;
            }
            
            const updatedPlayers = {
              ...gameState.players,
              [myId]: {
                id: myId,
                nickname: nickname.trim(),
                cards: [],
                marked: []
              }
            };

            await updateDoc(gameDocRef, { players: updatedPlayers });
          }
          setErrorMsg("");
        } catch (e) {
          console.error("Join failed:", e);
          setErrorMsg("åŠ å…¥éŠæˆ²å¤±æ•—ï¼Œå¯èƒ½éœ€è¦æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
        }
      };

      const handleStartGame = async () => {
        if (gameState.creatorId !== user.uid) {
             setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ä»¥ç™¼ç‰Œï¼");
             return;
        }
        
        const playerIds = Object.keys(gameState.players);
        if (playerIds.length === 0) return;

        // Generate Deck (1-13, 4 copies of each)
        let deck = [];
        for (let i = 1; i <= 13; i++) {
          deck.push(i, i, i, i);
        }
        // Shuffle
        deck = deck.sort(() => Math.random() - 0.5);

        const newPlayers = { ...gameState.players };
        const cardsPerPlayer = gameState.cardsPerPlayer || 5;

        playerIds.forEach((pid, index) => {
          newPlayers[pid] = {
            ...newPlayers[pid],
            // ç¢ºä¿ä¸æœƒç™¼è¶…å‡ºç‰Œçµ„çš„ç‰Œ
            cards: deck.slice(index * cardsPerPlayer, (index + 1) * cardsPerPlayer), 
            marked: []
          };
        });

        const gameDocRef = doc(db, 'artifacts', PUBLIC_APP_ID, 'public', 'data', 'pool_poker_room');
        await updateDoc(gameDocRef, {
          players: newPlayers,
          gameStarted: true,
          notice: 'éŠæˆ²é–‹å§‹ï¼'
        });
      };

      const handleRestart = async () => {
        if (gameState.creatorId !== user.uid) {
             setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ä»¥é‡é–‹ï¼");
             return;
        }

        const emptyPlayers = {};
        Object.keys(gameState.players).forEach(pid => {
          emptyPlayers[pid] = {
            ...gameState.players[pid],
            cards: [],
            marked: []
          };
        });

        const gameDocRef = doc(db, 'artifacts', PUBLIC_APP_ID, 'public', 'data', 'pool_poker_room');
        await updateDoc(gameDocRef, {
          players: emptyPlayers,
          gameStarted: false,
          notice: 'å·²é‡æ–°é–‹å±€'
        });
      };

      const handleMarkNumber = async (num) => {
        if (!gameState?.gameStarted) {
            setErrorMsg("éŠæˆ²å°šæœªé–‹å§‹ã€‚");
            return;
        }
        
        const myId = user.uid;
        const myData = gameState.players[myId];
        if (!myData) return; 
        
        if (myData.marked.includes(num)) return; 

        const newMarked = [...myData.marked, num];
        const gameDocRef = doc(db, 'artifacts', PUBLIC_APP_ID, 'public', 'data', 'pool_poker_room');
        
        await updateDoc(gameDocRef, {
          [`players.${myId}.marked`]: newMarked,
          notice: `${myData.nickname} æ¨™è¨˜äº† ${num} è™Ÿçƒ`
        });
      };

      // --- Helper: Ball Colors ---
      const getBallStyle = (num) => {
        const colors = {
          1: 'yellow', 2: 'blue', 3: 'red', 4: 'purple', 5: 'orange', 6: 'green', 7: 'brown', 8: 'black',
          9: 'yellow', 10: 'blue', 11: 'red', 12: 'purple', 13: 'orange'
        };
        const color = colors[num] || 'gray';
        const isStripe = num > 8;
        
        return { color, isStripe };
      };

      // --- Render Components ---

      if (loading || !user) return <div className="h-screen flex items-center justify-center text-emerald-400">æ­£åœ¨é€£æ¥ Firebase...</div>;

      const isJoined = gameState && gameState.players && gameState.players[user.uid];

      // LOGIN SCREEN
      if (!isJoined) {
        return (
          <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-700">
              <h1 className="text-3xl font-bold text-emerald-400 mb-6 text-center flex items-center justify-center gap-2">
                ğŸ± Pool Poker æ’çƒæ’²å…‹
              </h1>
              {errorMsg && <div className="bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm text-center">{errorMsg}</div>}
              
              <div className="space-y-4">
                <div>
                  <label className="block text-slate-400 text-sm mb-1">æš±ç¨±</label>
                  <input 
                    type="text" 
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:outline-none focus:border-emerald-500 transition"
                    placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±"
                  />
                </div>
                <button 
                  onClick={handleJoin}
                  className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded transition shadow-lg shadow-emerald-900/50"
                >
                  {gameState ? "åŠ å…¥ç¾æœ‰éŠæˆ²" : "å»ºç«‹æ–°æˆ¿é–“"}
                </button>
              </div>
              
              <div className="mt-6 text-xs text-slate-500 text-center">
                {gameState ? 
                  `${Object.keys(gameState.players || {}).length} ä½ç©å®¶å·²åœ¨ç­‰å€™` : 
                  "æˆç‚ºç¬¬ä¸€å€‹é–‹æ¡Œçš„äººï¼"
                }
              </div>
            </div>
          </div>
        );
      }

      // GAME BOARD
      const isCreator = gameState.creatorId === user.uid;

      return (
        <div className="min-h-screen bg-emerald-900 flex flex-col">
          {/* Header */}
          <div className="bg-emerald-950/80 p-4 shadow-md backdrop-blur-sm border-b border-emerald-800 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-50">
             <div className="flex items-center gap-2 mb-2 sm:mb-0">
                <span className="text-2xl">ğŸ±</span>
                <h1 className="font-bold text-white">Pool Poker</h1>
             </div>
             
             <div className="flex gap-2 text-sm">
               {isCreator && !gameState.gameStarted && (
                 <button onClick={handleStartGame} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded font-bold shadow-lg">
                   ç™¼ç‰Œé–‹å§‹éŠæˆ²
                 </button>
               )}
               {isCreator && (
                 <button onClick={handleRestart} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded shadow-lg">
                   é‡é–‹ä¸€å±€
                 </button>
               )}
             </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 p-4 max-w-6xl mx-auto w-full flex flex-col gap-6">
            
            {/* Notification Area */}
            {(errorMsg || gameState.notice) && (
              <div className={`p-3 rounded shadow-lg text-center text-sm ${errorMsg ? 'bg-red-500/90 text-white animate-pulse' : 'bg-blue-500/20 text-blue-300'}`}>
                {errorMsg || gameState.notice}
              </div>
            )}
            {!gameState.gameStarted && (
               <div className="bg-emerald-800/50 p-4 rounded-lg border border-emerald-700 text-center text-emerald-200">
                 ç­‰å¾…æˆ¿ä¸»ç™¼ç‰Œ... (ç›®å‰ {Object.keys(gameState.players).length} ä½ç©å®¶)
               </div>
            )}

            {/* Ball Selection Area */}
            {gameState.gameStarted && (
              <div className="bg-emerald-950/40 p-6 rounded-3xl border-[12px] border-amber-900 shadow-2xl relative">
                {/* Pockets visual (è£é£¾ç”¨) */}
                <div className="absolute top-0 left-0 w-8 h-8 bg-black rounded-br-full"></div>
                <div className="absolute top-0 right-0 w-8 h-8 bg-black rounded-bl-full"></div>
                <div className="absolute bottom-0 left-0 w-8 h-8 bg-black rounded-tr-full"></div>
                <div className="absolute bottom-0 right-0 w-8 h-8 bg-black rounded-tl-full"></div>
                
                <h2 className="text-center text-emerald-200/50 text-sm mb-4 font-mono uppercase tracking-widest">é»æ“Šä»¥æ¨™è¨˜æ“Šè½çš„çƒ (1-13)</h2>
                
                <div className="flex flex-wrap justify-center gap-3 sm:gap-4">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13].map((num) => {
                    const { color, isStripe } = getBallStyle(num);
                    const isMarked = gameState.players[user.uid]?.marked.includes(num);
                    
                    return (
                      <button
                        key={num}
                        onClick={() => handleMarkNumber(num)}
                        disabled={isMarked}
                        title={isMarked ? `å·²æ¨™è¨˜ ${num} è™Ÿçƒ` : `é»æ“Šæ¨™è¨˜ ${num} è™Ÿçƒ`}
                        className={`
                          w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center font-bold text-sm shadow-xl transition-transform active:scale-95
                          ${isMarked ? 'opacity-30 grayscale cursor-not-allowed scale-90' : 'hover:scale-110'}
                          ${isStripe ? 'stripe-ball' : 'ball'}
                        `}
                        style={{
                          backgroundColor: isStripe ? 'white' : color,
                          '--stripe-color': color,
                          color: isStripe ? 'black' : (num === 8 ? 'white' : 'white')
                        }}
                      >
                         <span className={isStripe ? 'stripe-text' : ''}>{num}</span>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Players Hands */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {Object.values(gameState.players).sort((a,b) => a.id === user.uid ? -1 : 1).map((player) => {
                const isMe = player.id === user.uid;
                
                return (
                  <div key={player.id} className={`
                    relative p-4 rounded-xl border-2 transition-all duration-300
                    ${isMe ? 'bg-emerald-800 border-emerald-400 shadow-lg scale-[1.02]' : 'bg-emerald-900/60 border-emerald-800'}
                  `}>
                    <div className="flex justify-between items-center mb-3">
                      <div className="flex items-center gap-2">
                        <div className={`w-3 h-3 rounded-full ${isMe ? 'bg-green-400' : 'bg-slate-500'}`}></div>
                        <span className={`font-bold ${isMe ? 'text-white' : 'text-emerald-200'}`}>
                          {player.nickname} {isMe && '(æ‚¨)'}
                        </span>
                      </div>
                      <span className="text-xs text-emerald-400 font-mono">
                        å·²æ“Šè½ {player.marked?.length || 0} å€‹ç›®æ¨™
                      </span>
                    </div>

                    <div className="flex flex-wrap gap-2 min-h-[60px]">
                      {gameState.gameStarted && player.cards && player.cards.map((card, idx) => {
                        const isMarked = player.marked.includes(card);
                        // é¡¯ç¤ºæ¢ä»¶ï¼šæ˜¯è‡ªå·±çš„å¡ç‰Œ OR è©²è™Ÿç¢¼å·²è¢«æ¨™è¨˜
                        const isVisible = isMe || isMarked;
                        
                        return (
                          <div 
                            key={`${player.id}-${idx}`}
                            className={`
                              w-10 h-14 sm:w-12 sm:h-16 rounded flex items-center justify-center text-lg font-bold shadow-sm transition-all duration-500
                              ${!isVisible 
                                ? 'bg-emerald-700 border border-emerald-600 opacity-80' // å¡èƒŒ
                                : isMarked 
                                  ? 'bg-yellow-400 text-black border-2 border-yellow-200 scale-105 shadow-yellow-500/50' // æ“Šè½çš„å¡
                                  : 'bg-white text-slate-800' // è‡ªå·±çš„å¡
                              }
                            `}
                          >
                             {isVisible ? card : ''}
                          </div>
                        );
                      })}
                      
                      {gameState.gameStarted && (!player.cards || player.cards.length === 0) && (
                        <div className="text-sm text-emerald-500 italic w-full text-center py-2">å°šæœªç™¼ç‰Œ</div>
                      )}
                      
                      {!gameState.gameStarted && (
                        <div className="text-sm text-emerald-500 italic w-full text-center py-2">ç­‰å¾…ä¸­...</div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

