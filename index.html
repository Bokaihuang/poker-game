<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool Poker æ’çƒæ’²å…‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: white; }
    
    /* Pool Ball Styles */
    .ball {
      box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 2px 2px 5px rgba(0,0,0,0.3);
    }
    .stripe-ball {
      background: white;
      position: relative;
      overflow: hidden;
    }
    .stripe-ball::before {
      content: '';
      position: absolute;
      top: 20%;
      bottom: 20%;
      left: 0;
      right: 0;
      background: var(--stripe-color);
    }
    .stripe-text {
      position: relative;
      z-index: 10;
      background: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: black;
    }
    /* æ’²å…‹ç‰Œæ¨£å¼ */
    .card-face {
        font-size: 1.2rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .card-back {
        background: linear-gradient(135deg, #10b981, #059669);
        border: 2px solid #34d399;
    }
    /* ä½¿æ¨™è¨˜çš„çƒåœ¨èƒŒæ™¯ä¸­é–ƒçˆ */
    @keyframes pulse-marked {
      0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5); }
      50% { box-shadow: 0 0 15px 5px rgba(251, 191, 36, 0.8); }
    }
    .marked-ball {
        animation: pulse-marked 2s infinite ease-in-out;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase åˆå§‹åŒ–ï¼šä½¿ç”¨ Canvas ç’°å¢ƒæ³¨å…¥çš„è®Šæ•¸ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. å–å¾— Canvas ç’°å¢ƒæä¾›çš„å…¨åŸŸè®Šæ•¸
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // ç¢ºä¿ appId å­˜åœ¨

    // 2. æ ¹æ“š Firestore å®‰å…¨è¦å‰‡è¨­å®šå…¬å…±è³‡æ–™è·¯å¾‘
    // è·¯å¾‘çµæ§‹ï¼š/artifacts/{appId}/public/data/pool_poker_rooms/main_room
    window.GAME_ROOM_PATH = `artifacts/${appId}/public/data/pool_poker_rooms/main_room`; 

    // 3. åˆå§‹åŒ– Firebase
    let app;
    try {
        if (Object.keys(firebaseConfig).length === 0) {
            throw new Error("Firebase config not found.");
        }
        app = initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Firebase initialization failed:", e.message);
        // å³ä½¿åˆå§‹åŒ–å¤±æ•—ï¼Œä¹Ÿè®“æ‡‰ç”¨ç¨‹å¼ç¹¼çºŒï¼ŒReact çµ„ä»¶å°‡é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    }
    
    if (app) {
        // 4. è¨­ç½®å…¨åŸŸè®Šæ•¸ä¾› React å…ƒä»¶ä½¿ç”¨
        window.auth = getAuth(app); 
        window.db = getFirestore(app);
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.onAuthStateChanged = onAuthStateChanged; 
        
        setLogLevel('debug'); // å•Ÿç”¨ debug log
        
        // 5. åŸ·è¡Œèªè­‰ï¼šå„ªå…ˆä½¿ç”¨è‡ªå®šç¾© Tokenï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨åŒ¿åç™»å…¥
        (async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth); 
                }
                console.log("Firebase Auth success.");
            } catch (error) {
                console.error("Firebase Auth Failed:", error);
            }
        })();
    } else {
        // è¨­ç½®ç©ºå°è±¡ä»¥é˜²æ­¢ React è…³æœ¬ä¸­å¼•ç”¨ 'window.auth' ç­‰è®Šæ•¸æ™‚æ‹‹å‡ºéŒ¯èª¤
        window.auth = {};
        window.db = {};
        window.onAuthStateChanged = (auth, callback) => callback(null);
    }
  </script>

  <!-- React æ‡‰ç”¨ç¨‹å¼ - type="text/babel" -->
  <script type="text/babel">
    // å¾ window è§£æ§‹ Firebase å‡½æ•¸å’Œè®Šæ•¸
    const { 
        auth, db, doc, onSnapshot, setDoc, updateDoc, 
        onAuthStateChanged, GAME_ROOM_PATH 
    } = window;
    
    // --- POKER HAND EVALUATION LOGIC æ’²å…‹ç‰Œå‹è©•ä¼°é‚è¼¯ ---

    /**
     * å°‡å¡ç‰‡æ•¸å­—è½‰æ›ç‚ºæ’²å…‹ç‰Œé¡¯ç¤ºå€¼ (1=A, 11=J, 12=Q, 13=K)
     */
    const getCardValueDisplay = (num) => {
        if (num === 1) return 'A';
        if (num === 11) return 'J';
        if (num === 12) return 'Q';
        if (num === 13) return 'K';
        return String(num);
    };

    /**
     * è©•ä¼° 5 å¼µç‰Œçš„æ‰‹ç‰Œåƒ¹å€¼ (ç„¡èŠ±è‰²/Suit)
     * @param {number[]} cards - 5 å¼µ 1-13 ä¹‹é–“çš„æ•¸å­—ç‰Œ
     * @returns {string} ç‰Œå‹åç¨±
     */
    const evaluateHand = (cards) => {
        if (!cards || cards.length !== 5) return 'ç„¡ç‰Œ';
        
        // 1. æ’åºå¡ç‰‡ä¸¦è¨ˆç®—æ¬¡æ•¸ (Rank Frequencies)
        const ranks = cards.slice().sort((a, b) => a - b); 
        const counts = {};
        for (const rank of ranks) {
            counts[rank] = (counts[rank] || 0) + 1;
        }
        const countValues = Object.values(counts); // e.g., [1, 2, 2] for Two Pair
        
        // 2. æª¢æŸ¥é †å­ (Straight)
        const isStraight = (arr) => {
            const sortedUniqueRanks = [...new Set(arr)].sort((a, b) => a - b);
            
            // éœ€è¦ 5 å¼µä¸åŒçš„ç‰Œæ‰èƒ½æ§‹æˆé †å­
            if (sortedUniqueRanks.length < 5) return false;

            // è™•ç† A-5 (1, 2, 3, 4, 5) é †å­ (Ace low)
            const isAlowStraight = sortedUniqueRanks.join(',') === '1,2,3,4,5';

            // è™•ç† K-A (10, 11, 12, 13, 1) é †å­ (Ace high)
            const isAhighStraight = sortedUniqueRanks.join(',') === '1,10,11,12,13'; 
            
            // è™•ç†ä¸€èˆ¬é †å­ (é€£çºŒ 5 å¼µ)
            const isRegularStraight = sortedUniqueRanks[4] - sortedUniqueRanks[0] === 4;
            
            return isAlowStraight || isAhighStraight || isRegularStraight;
        };

        const straight = isStraight(ranks);
        
        // 3. æª¢æŸ¥ç‰Œå‹ (å¾é«˜åˆ°ä½)
        if (countValues.includes(4)) return 'å››æ¢ (Four of a Kind)';
        if (countValues.includes(3) && countValues.includes(2)) return 'è‘«è˜† (Full House)';
        
        // åœ¨ç„¡èŠ±è‰²çš„è¦å‰‡ä¸‹ï¼Œé †å­æ’ååœ¨è‘«è˜†å’Œä¸‰æ¢ä¹‹é–“
        if (straight) return 'é †å­ (Straight)'; 

        if (countValues.includes(3)) return 'ä¸‰æ¢ (Three of a Kind)';
        
        const pairs = countValues.filter(v => v === 2).length;
        if (pairs === 2) return 'å…©å° (Two Pair)';
        if (pairs === 1) return 'ä¸€å° (Pair)';
        
        // 4. æœ€å¾Œæ˜¯é«˜ç‰Œ (High Card)
        return 'é«˜ç‰Œ (High Card)';
    };


    const App = () => {
      const [user, setUser] = React.useState(null);
      const [gameState, setGameState] = React.useState(null);
      const [nickname, setNickname] = React.useState('');
      const [loading, setLoading] = React.useState(true);
      const [errorMsg, setErrorMsg] = React.useState('');

      // --- Authentication & Data Sync ---
      React.useEffect(() => {
        // æª¢æŸ¥ Firebase æœå‹™æ˜¯å¦å¯ç”¨
        if (!auth || !db) {
            setErrorMsg("Firebase æœå‹™æœªæ­£ç¢ºåˆå§‹åŒ–ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨ Consoleã€‚");
            setLoading(false);
            return;
        }

        const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
          setUser(currentUser);
          setLoading(false);
        }, (error) => {
            console.error("Auth Error:", error);
            setErrorMsg("èº«ä»½é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ– Firebase è¨­å®šã€‚");
            setLoading(false);
        });
        return () => unsubscribeAuth();
      }, []);

      // --- Firestore Listener ---
      React.useEffect(() => {
        // ç¢ºä¿ user å·²ç¶“è¢«è¨­ç½®ä¸” loading çµæŸï¼Œä¸” db æœå‹™å¯ç”¨
        if (!user || loading || !db) return; 

        const gameDocRef = doc(db, GAME_ROOM_PATH);

        const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {
          if (docSnap.exists()) {
            setGameState(docSnap.data());
          } else {
            setGameState(null); // Room doesn't exist yet
          }
          if(errorMsg.includes("é€£ç·šéŒ¯èª¤")) setErrorMsg(""); // æ¸…é™¤é€£ç·šéŒ¯èª¤è¨Šæ¯
        }, (error) => {
          console.error("Snapshot error:", error);
          setErrorMsg("é€£ç·šéŒ¯èª¤ï¼šç„¡æ³•è®€å–éŠæˆ²ç‹€æ…‹ã€‚è«‹æª¢æŸ¥ Firebase Console ä¸Šçš„éŒ¯èª¤è³‡è¨Šã€‚");
          setLoading(false); 
        });

        return () => unsubscribe();
      }, [user, loading, db]); // ä¾è³´æ–¼ user å’Œ db ç‹€æ…‹

      // --- Game Actions ---

      const handleJoin = async () => {
        if (!nickname.trim()) {
          setErrorMsg("è«‹è¼¸å…¥æš±ç¨±");
          return;
        }

        const gameDocRef = doc(db, GAME_ROOM_PATH);
        const myId = user.uid;
        
        try {
          if (!gameState) {
            // Create new game (ç¸½å…± 52 å¼µç‰Œï¼Œæ¯å¼µç‰Œæœ‰ 4 å€‹è¤‡æœ¬)
            await setDoc(gameDocRef, {
              creatorId: myId,
              gameStarted: false,
              cardsPerPlayer: 5,
              players: {
                [myId]: {
                  id: myId,
                  nickname: nickname.trim(),
                  cards: [], // ç‰Œé¢æ•¸å€¼ (1-13)
                  marked: [] // å·²æ“Šè½çš„çƒæ•¸å€¼ (1-13)
                }
              },
              lastUpdated: new Date().toISOString()
            });
          } else {
            // Join existing
            if (Object.keys(gameState.players || {}).length >= 5) {
              setErrorMsg("æˆ¿é–“å·²æ»¿ (ä¸Šé™ 5 äºº)ï¼");
              return;
            }
            
            // é¿å…é‡è¤‡åŠ å…¥
            if(gameState.players[myId]) {
                 setErrorMsg("æ‚¨å·²åœ¨æˆ¿é–“å…§ï¼Œç„¡éœ€é‡è¤‡åŠ å…¥ã€‚");
                 return;
            }

            const updatedPlayers = {
              ...gameState.players,
              [myId]: {
                id: myId,
                nickname: nickname.trim(),
                cards: [],
                marked: []
              }
            };

            await updateDoc(gameDocRef, { players: updatedPlayers });
          }
          setErrorMsg("");
        } catch (e) {
          console.error("Join failed:", e);
          setErrorMsg("åŠ å…¥éŠæˆ²å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥ Firebase Console ä¸Šçš„éŒ¯èª¤è³‡è¨Šã€‚");
        }
      };

      const handleStartGame = async () => {
        if (!gameState) return;
        if (gameState.creatorId !== user.uid) {
            setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ä»¥ç™¼ç‰Œï¼");
            return;
        }
        
        const playerIds = Object.keys(gameState.players);
        if (playerIds.length === 0) return;

        // å»ºç«‹ 1-13 è™Ÿçƒï¼Œæ¯è™Ÿ 4 å¼µ (æ¨¡æ“¬ 4 å‰¯èŠ±è‰²)
        let deck = [];
        for (let i = 1; i <= 13; i++) {
          deck.push(i, i, i, i);
        }
        deck = deck.sort(() => Math.random() - 0.5); // æ´—ç‰Œ

        const newPlayers = { ...gameState.players };
        const cardsPerPlayer = gameState.cardsPerPlayer || 5;

        // ç™¼ç‰Œ
        playerIds.forEach((pid, index) => {
          newPlayers[pid] = {
            ...newPlayers[pid],
            // ç™¼ç‰Œä¸¦å¾ç‰Œå †ä¸­ç§»é™¤å·²ç™¼çš„ç‰Œ
            cards: deck.splice(0, cardsPerPlayer), 
            marked: []
          };
        });

        const gameDocRef = doc(db, GAME_ROOM_PATH);
        await updateDoc(gameDocRef, {
          players: newPlayers,
          gameStarted: true,
          notice: `éŠæˆ²é–‹å§‹ï¼æˆ¿ä¸»ç™¼äº† ${cardsPerPlayer} å¼µç‰Œã€‚`
        });
      };

      const handleRestart = async () => {
        if (!gameState) return;
        if (gameState.creatorId !== user.uid) {
            setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ä»¥é‡é–‹ï¼");
            return;
        }

        const emptyPlayers = {};
        Object.keys(gameState.players).forEach(pid => {
          emptyPlayers[pid] = {
            ...gameState.players[pid],
            cards: [],
            marked: []
          };
        });

        const gameDocRef = doc(db, GAME_ROOM_PATH);
        await updateDoc(gameDocRef, {
          players: emptyPlayers,
          gameStarted: false,
          notice: 'éŠæˆ²å·²é‡é–‹ï¼Œè«‹ç­‰å¾…æˆ¿ä¸»é‡æ–°ç™¼ç‰Œã€‚'
        });
      };

      const handleMarkNumber = async (num) => {
        if (!gameState?.gameStarted) {
            setErrorMsg("éŠæˆ²å°šæœªé–‹å§‹ã€‚");
            return;
        }
        
        const myId = user.uid;
        const myData = gameState.players[myId];
        if (!myData) return; 
        
        // æª¢æŸ¥æ˜¯å¦å·²æ¨™è¨˜
        if (myData.marked.includes(num)) return; 

        const newMarked = [...myData.marked, num];
        const gameDocRef = doc(db, GAME_ROOM_PATH);
        
        await updateDoc(gameDocRef, {
          [`players.${myId}.marked`]: newMarked,
          notice: `${myData.nickname} æ¨™è¨˜äº† ${num} è™Ÿçƒå·²å…¥è¢‹ã€‚`
        });
      };

      // --- Helper: Ball Colors ---

      const getBallStyle = (num) => {
        const colors = {
          1: 'yellow', 2: 'blue', 3: 'red', 4: 'purple', 5: 'orange', 6: 'green', 7: 'brown', 8: 'black',
          9: 'yellow', 10: 'blue', 11: 'red', 12: 'purple', 13: 'orange'
        };
        const color = colors[num] || 'gray';
        const isStripe = num > 8;
        
        return { color, isStripe };
      };

      // --- Render Components ---

      if (loading || !user) {
          return (
            <div className="h-screen flex flex-col items-center justify-center p-4 bg-slate-900">
                {errorMsg && (
                    <div className="bg-red-500/20 text-red-300 p-4 rounded mb-4 text-center max-w-sm">
                        é€£ç·šç™¼ç”Ÿè‡´å‘½éŒ¯èª¤ï¼š{errorMsg}
                        <div className="text-xs mt-2 text-red-400">è«‹ç¢ºèªæ‚¨çš„ Firebase é€£ç·šç‹€æ…‹ã€‚</div>
                    </div>
                )}
                <div className="text-emerald-400 text-lg">æ­£åœ¨é€£æ¥ Firebase...</div>
            </div>
          );
      }

      const isJoined = gameState && gameState.players && gameState.players[user.uid];

      if (!isJoined) {
        return (
          <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-700">
              <h1 className="text-3xl font-bold text-emerald-400 mb-6 text-center flex items-center justify-center gap-2">
                ğŸ± Pool Poker æ’çƒæ’²å…‹
              </h1>
              <p className="text-slate-400 text-sm mb-6 text-center">
                User ID: <span className="text-xs font-mono text-slate-300">{user.uid}</span>
              </p>
              {errorMsg && <div className="bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm text-center">{errorMsg}</div>}
              
              <div className="space-y-4">
                <div>
                  <label htmlFor="nickname" className="block text-slate-400 text-sm mb-1">æš±ç¨±</label>
                  <input 
                    id="nickname"
                    type="text" 
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:outline-none focus:border-emerald-500 transition"
                    placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±"
                  />
                </div>
                <button 
                  onClick={handleJoin}
                  className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded transition shadow-lg shadow-emerald-900/50"
                >
                  {gameState ? "åŠ å…¥ç¾æœ‰éŠæˆ²" : "å»ºç«‹æ–°æˆ¿é–“"}
                </button>
              </div>
              
              <div className="mt-6 text-xs text-slate-500 text-center">
                {gameState ? 
                  `${Object.keys(gameState.players || {}).length} ä½ç©å®¶å·²åœ¨ç­‰å€™` : 
                  "æˆç‚ºç¬¬ä¸€å€‹é–‹æ¡Œçš„äººï¼"
                }
              </div>
            </div>
          </div>
        );
      }

      // GAME BOARD
      const isCreator = gameState.creatorId === user.uid;

      return (
        <div className="min-h-screen bg-emerald-900 flex flex-col">
          {/* Header */}
          <div className="bg-emerald-950/80 p-4 shadow-md backdrop-blur-sm border-b border-emerald-800 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-50">
             <div className="flex items-center gap-2 mb-2 sm:mb-0">
               <span className="text-2xl">ğŸ±</span>
               <h1 className="font-bold text-white text-lg sm:text-xl">Pool Poker (æ’çƒæ’²å…‹)</h1>
             </div>
             
             <div className="flex gap-2 text-sm">
               {isCreator && !gameState.gameStarted && Object.keys(gameState.players).length > 0 && (
                 <button onClick={handleStartGame} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded font-bold shadow-lg transition duration-200">
                   ç™¼ç‰Œé–‹å§‹éŠæˆ²
                 </button>
               )}
               {isCreator && (
                 <button onClick={handleRestart} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded shadow-lg transition duration-200">
                   é‡é–‹ä¸€å±€
                 </button>
               )}
             </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 p-4 max-w-6xl mx-auto w-full flex flex-col gap-6">
            
            {/* Notification Area */}
            <div className={`p-3 rounded shadow-lg text-center text-sm transition-all duration-300 ${
                errorMsg 
                ? 'bg-red-500/90 text-white animate-pulse' 
                : gameState.notice 
                  ? 'bg-blue-500/20 text-blue-300' 
                  : 'bg-transparent'
            }`}>
              {errorMsg || gameState.notice || (gameState.gameStarted ? 'éŠæˆ²é€²è¡Œä¸­' : 'ç­‰å¾…ä¸­...')}
            </div>

            {/* Ball Selection Area (æ¨¡æ“¬çƒæ¡Œ) */}
            {gameState.gameStarted && (
              <div className="bg-emerald-950/40 p-6 rounded-3xl border-[12px] border-amber-900 shadow-2xl relative">
                {/* Pockets visual (è£é£¾ç”¨) */}
                <div className="absolute top-0 left-0 w-8 h-8 bg-black rounded-br-full z-10"></div>
                <div className="absolute top-0 right-0 w-8 h-8 bg-black rounded-bl-full z-10"></div>
                <div className="absolute bottom-0 left-0 w-8 h-8 bg-black rounded-tr-full z-10"></div>
                <div className="absolute bottom-0 right-0 w-8 h-8 bg-black rounded-tl-full z-10"></div>
                
                <h2 className="text-center text-emerald-200/50 text-sm mb-4 font-mono uppercase tracking-widest">é»æ“Šä»¥æ¨™è¨˜æ“Šè½çš„ç›®æ¨™çƒ (1-13)</h2>
                
                <div className="flex flex-wrap justify-center gap-3 sm:gap-4">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13].map((num) => {
                    const { color, isStripe } = getBallStyle(num);
                    const isMarked = gameState.players[user.uid]?.marked.includes(num);
                    
                    return (
                      <button
                        key={num}
                        onClick={() => handleMarkNumber(num)}
                        disabled={isMarked}
                        title={isMarked ? `å·²æ¨™è¨˜ ${num} è™Ÿçƒ` : `é»æ“Šæ¨™è¨˜ ${num} è™Ÿçƒ`}
                        className={`
                          w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center font-bold text-sm shadow-xl transition-transform active:scale-95
                          ${isMarked ? 'opacity-30 grayscale cursor-not-allowed scale-90 marked-ball' : 'hover:scale-110'}
                          ${isStripe ? 'stripe-ball' : 'ball'}
                        `}
                        style={{
                          backgroundColor: isStripe ? 'white' : color,
                          '--stripe-color': color,
                          color: isStripe ? 'black' : (num === 8 ? 'white' : 'white')
                        }}
                      >
                          <span className={isStripe ? 'stripe-text' : ''}>{num}</span>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Players Hands */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {Object.values(gameState.players).sort((a,b) => a.id === user.uid ? -1 : 1).map((player) => {
                const isMe = player.id === user.uid;
                const handValue = gameState.gameStarted && player.cards?.length === 5 ? evaluateHand(player.cards) : null;
                
                return (
                  <div key={player.id} className={`
                    relative p-4 rounded-xl border-2 transition-all duration-300
                    ${isMe ? 'bg-emerald-800 border-yellow-400 shadow-xl scale-[1.02]' : 'bg-emerald-900/60 border-emerald-800'}
                  `}>
                    <div className="flex justify-between items-center mb-3">
                      <div className="flex items-center gap-2">
                        <div className={`w-3 h-3 rounded-full ${isMe ? 'bg-green-400' : 'bg-slate-500'}`}></div>
                        <span className={`font-bold ${isMe ? 'text-white' : 'text-emerald-200'}`}>
                          {player.nickname} {isMe && '(æ‚¨)'}
                        </span>
                      </div>
                      <span className="text-xs text-emerald-400 font-mono">
                        å·²æ“Šè½ {player.marked?.length || 0} å€‹ç›®æ¨™
                      </span>
                    </div>

                    <div className="flex flex-wrap gap-2 min-h-[60px]">
                      {gameState.gameStarted && player.cards && player.cards.map((card, idx) => {
                        const isMarked = player.marked.includes(card);
                        const isVisible = isMe || isMarked;
                        
                        return (
                          <div 
                            key={`${player.id}-${idx}`}
                            className={`
                              w-10 h-14 sm:w-12 sm:h-16 rounded flex items-center justify-center text-lg font-bold shadow-md transition-all duration-500
                              ${!isVisible 
                                ? 'card-back text-transparent' // å¡èƒŒ
                                : isMarked 
                                  ? 'bg-yellow-400 text-black border-2 border-yellow-200 scale-105 shadow-yellow-500/50 card-face' // æ¨™è¨˜ç‰Œ
                                  : 'bg-white text-slate-800 card-face' // äº®ç‰Œ
                              }
                            `}
                            title={isMarked ? `æ“Šè½äº† ${getCardValueDisplay(card)}!` : (isVisible ? getCardValueDisplay(card) : 'æœªæ“Šè½')}
                          >
                              {isVisible ? getCardValueDisplay(card) : ''}
                          </div>
                        );
                      })}
                      
                      {/* éŠæˆ²æœªé–‹å§‹æˆ–ç„¡ç‰Œæ™‚çš„è¨Šæ¯ */}
                      {gameState.gameStarted && (!player.cards || player.cards.length === 0) && (
                        <div className="text-sm text-emerald-500 italic w-full text-center py-2">å°šæœªç™¼ç‰Œ (è«‹æˆ¿ä¸»é–‹å§‹éŠæˆ²)</div>
                      )}
                      
                      {!gameState.gameStarted && (
                        <div className="text-sm text-emerald-500 italic w-full text-center py-2">ç­‰å¾…ä¸­...</div>
                      )}
                    </div>

                    {/* ç‰Œå‹é¡¯ç¤º */}
                    <div className="text-xs text-slate-400 mt-3 pt-3 border-t border-emerald-700">
                        <span className="font-semibold text-emerald-300">ç‰Œå‹: </span>
                        <span className={`font-bold ${handValue ? 'text-yellow-300' : 'text-slate-500'}`}>
                            {handValue || 'ç­‰å¾…ç™¼ç‰Œ'}
                        </span>
                    </div>

                  </div>
                );
              })}
            </div>

          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
