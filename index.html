<!doctype html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pool Poker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #071024;
            color: #e6eef8;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        }

        .card {
            width: 54px;
            height: 74px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .6);
        }

        .card-back {
            background: linear-gradient(180deg, #0b1220, #081228);
            border: 2px solid rgba(255, 255, 255, .04);
            color: transparent;
        }

        .card-face {
            background: white;
            color: #071024;
            border: 2px solid rgba(2, 6, 23, .06);
        }

        .marked {
            position: relative;   /* ä¿ç•™ä»¥ä½¿ç”¨ ::after */
        }  
        .marked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgb(109, 176, 240);
            transform: rotate(-45deg);
        }

        .small {
            font-size: .85rem;
            color: #cfe8ff;
        }

        .suit-red {
            color: #dc2626;
        }

        .suit-black {
            color: #111827;
        }

        .foul-btn {
            background: #ef4444;
            color: white;
            padding: 6px 8px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .foul-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .player-header {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
        }

        /* ===== çƒæŒ‰éˆ• ç¾åŒ– ===== */
        .ball-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 4px;
            user-select: none;
            transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease, filter 160ms ease;
            box-shadow: 0 6px 12px rgba(2, 6, 23, 0.6), inset 0 -6px 10px rgba(255, 255, 255, 0.03);
            color: #071024;
            font-size: 14px;
            position: relative;
        }

        .ball-btn:hover {
            transform: translateY(-3px) scale(1.03);
            filter: brightness(1.06);
        }

        .ball-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* é¸ä¸­ç‹€æ…‹ */
        .ball-btn.selected {
            border-color: #55CCFF;
            box-shadow: 0 8px 18px rgba(85, 204, 255, 0.2), 0 0 8px rgba(85, 204, 255, 0.3);
            transform: scale(1.12);
            filter: brightness(1.08);
        }

        /* çƒé¡è‰² */
        .ball-yellow {
            --ball-color-solid: #FFA600;
            background: linear-gradient(180deg, #ffc65b, #ffa600);
        }

        .ball-blue {
            --ball-color-solid: #2337f0;
            background: linear-gradient(180deg, #3462c5, #0011aa);
            color: white;
        }

        .ball-red {
            --ball-color-solid: #CC0000;
            background: linear-gradient(180deg, #e64a4a, #cc0000);
            color: white;
        }

        .ball-purple {
            --ball-color-solid: #5733bb;
            background: linear-gradient(180deg, #615ac4, #5733bb);
            color: white;
        }

        .ball-orange {
            --ball-color-solid: #dd7d00;
            background: linear-gradient(180deg, #fcae61, #dd7d00);
        }

        .ball-green {
            --ball-color-solid: #129900;
            background: linear-gradient(180deg, #64b84f, #138304);
            color: white;
        }

        .ball-maroon {
            --ball-color-solid: #663333;
            background: linear-gradient(180deg, #9e5f5f, #663633);
            color: white;
        }

        .ball-black {
            --ball-color-solid: #000000;
            background: radial-gradient(circle at 30% 30%, #a39595, #000000 60%);
            color: white;
            border-color: rgba(255, 255, 255, 0.06);
        }

        /* stripe çƒ (9~13) */
        .ball-stripe {
            background: linear-gradient(to bottom,
                    white 0%,
                    white 20%,
                    var(--ball-color-solid) 20%,
                    var(--ball-color-solid) 80%,
                    white 80%,
                    white 100%);
            color: #071024;
            font-weight: 700;
            overflow: hidden;
        }

        /* ===== è·‘é¦¬ç‡ˆæ¨£å¼ ===== */
        #marqueeContainer {
            overflow: hidden;
            white-space: nowrap;
            background-color: #1e293b;
            /* æ·±è—ç°èƒŒæ™¯ */
            padding: 6px 0;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        #marqueeText {
            display: inline-block;
            color: #fde047;
            /* é»ƒè‰²æ–‡å­— */
            font-weight: 700;
            padding-left: 100%;
            /* å¾å³é‚Šé–‹å§‹ç§»å‹• */
            animation: marquee 15s linear infinite;
            /* 30ç§’ä¸€å€‹å¾ªç’° */
        }

        @keyframes marquee {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-100%, 0);
            }
        }

        @media (max-width:640px) {
            .ball-btn {
                width: 34px;
                height: 34px;
                font-size: 13px;
                margin: 3px;
            }
        }
    </style>
</head>

<body>
    <div class="max-w-5xl mx-auto p-6">
        <div id="marqueeContainer">
            <div id="marqueeText">æ­¡è¿ä½¿ç”¨ ~ Card Pool Challengeï¼</div>
        </div>

        <div id="status" class="mb-4 text-sm small">åˆå§‹åŒ–ä¸­â€¦</div>

        <div id="joinPanel" class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="col-span-2">
                <label class="small">æš±ç¨±</label>
                <input id="nickname" class="w-full p-2 rounded bg-slate-800 border border-slate-700"
                    placeholder="è¼¸å…¥æš±ç¨±" />
            </div>
            <div>
                <button id="btnJoin" class="w-full py-2 rounded bg-emerald-600 hover:bg-emerald-500">åŠ å…¥æˆ¿é–“</button>
            </div>
        </div>

        <div id="roomPanel" class="mb-6 p-4 rounded bg-slate-900 border border-slate-700 hidden">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="text-xs small">æˆ¿é–“ ID</div>
                    <div class="font-mono">main-room</div>
                </div>
                <div>
                    <div class="text-xs small">æˆ¿ä¸»</div>
                    <div id="roomOwner" class="font-bold">â€”</div>
                </div>
                <div>
                    <div class="text-xs small">äººæ•¸</div>
                    <div id="roomCount">0 / 5</div>
                </div>
                <div>
                    <div class="text-xs small">æˆ‘çš„æš±ç¨±</div>
                    <div id="myNick" class="font-mono">â€”</div>
                </div>
            </div>

            <div class="flex gap-2 items-center mb-4">
                <button id="btnStart" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-500 hidden">ç™¼ç‰Œ</button>
                <button id="btnRestart" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 hidden">é‡é–‹</button>
                <button id="btnLeave" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 ml-auto">é€€å‡ºæˆ¿é–“</button>
                <div id="notice" class="ml-4 small text-slate-300"></div>
            </div>

            <div id="ballButtons" class="mb-4"></div>
            <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, deleteDoc, serverTimestamp, arrayUnion, arrayRemove, deleteField, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0",
            authDomain: "poolpokergame-b88ed.firebaseapp.com",
            projectId: "poolpokergame-b88ed",
            storageBucket: "poolpokergame-b88ed.firebasestorage.app",
            messagingSenderId: "574863840102",
            appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
        };

        const APP_ID = EXTERNAL_FIREBASE_CONFIG.projectId;
        const ROOM_PATH = `artifacts/${APP_ID}/public/data/pool_poker_rooms/main_room`;
        const CARDS_PER_PLAYER = 8;
        const MAX_PLAYERS = 5;
        const MAX_EXTRA = 6;

        const statusEl = document.getElementById('status');
        const nicknameInput = document.getElementById('nickname');
        const btnJoin = document.getElementById('btnJoin');
        const joinPanel = document.getElementById('joinPanel');
        const roomPanel = document.getElementById('roomPanel');
        const roomOwnerEl = document.getElementById('roomOwner');
        const roomCountEl = document.getElementById('roomCount');
        const playersArea = document.getElementById('playersArea');
        const myNickEl = document.getElementById('myNick');
        const btnStart = document.getElementById('btnStart');
        const btnRestart = document.getElementById('btnRestart');
        const btnLeave = document.getElementById('btnLeave');
        const noticeEl = document.getElementById('notice');
        const ballButtonsEl = document.getElementById('ballButtons');
        const marqueeTextEl = document.getElementById('marqueeText');

        const app = initializeApp(EXTERNAL_FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const roomRef = doc(db, ROOM_PATH);

        let currentUser = null;
        let gameState = null;
        let myNickname = '';

        function setStatus(s) { statusEl.textContent = s; }

        async function doAnonymousAuth() {
            setStatus('ä½¿ç”¨åŒ¿åç™»å…¥ Firebase...');
            try { const cred = await signInAnonymously(auth); console.log('signed in uid=', cred.user.uid); }
            catch (e) { console.log('auth failed', e); setStatus('Auth å¤±æ•—'); }
        }

        onAuthStateChanged(auth, (user) => { currentUser = user; if (user) { setStatus('å·²ç™»å…¥ï¼š' + user.uid); subscribeRoom(); } else { setStatus('æœªç™»å…¥'); } });

        let unsubscribe = null;
        function subscribeRoom() {
            if (unsubscribe) return;
            setStatus('è¨‚é–± main-room...');
            unsubscribe = onSnapshot(roomRef, (snap) => {
                if (!snap.exists()) { gameState = null; renderUI(); setStatus('æˆ¿é–“å°šæœªå»ºç«‹æˆ–å·²è¢«æ¸…ç©º'); return; }
                gameState = snap.data(); renderUI(); setStatus('å·²é€£åˆ°æˆ¿é–“');
            }, (err) => { console.log('snapshot err', err); setStatus('è¨‚é–±å¤±æ•—'); });
        }

        const suits = ['â™£', 'â™¦', 'â™¥', 'â™ '];
        const rankMap = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K' };

        function getCardRank(cardCode) {
            const r = cardCode.slice(1);
            if (r === 'A') return 1;
            if (r === 'J') return 11;
            if (r === 'Q') return 12;
            if (r === 'K') return 13;
            return parseInt(r);
        }

        function buildDeck() { const deck = []; for (let r = 1; r <= 13; r++) { for (let s = 0; s < 4; s++) { const rank = rankMap[r] || String(r); deck.push({ suit: suits[s], rank, code: `${suits[s]}${rank}` }); } } return deck; }
        function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

        function calculateUnmarkedCards(cards, revealedNumbers) {
            if (!cards || cards.length === 0) return 0;
            if (!revealedNumbers || revealedNumbers.length === 0) return cards.length;
            let unmarkedCount = 0;
            for (const cardCode of cards) {
                const rank = getCardRank(cardCode);
                if (!revealedNumbers.includes(rank)) {
                    unmarkedCount++;
                }
            }
            return unmarkedCount;
        }

        function updateMarquee() {
            if (!gameState || !gameState.gameStarted) {
                marqueeTextEl.textContent = "ğŸ± Welcome to Card Pool Challenge.  ç¨ç­‰ç™¼ç‰Œ...éŠæˆ²å³å°‡é–‹å§‹ ~ é ç¥å„ä½éƒ½èƒ½æŠ½å‰¯å¥½ç‰Œï¼";
                return;
            }

            const players = gameState.players || {};
            const revealedNumbers = gameState.revealedNumbers || [];
            const messages = [];

            for (const playerId in players) {
                const player = players[playerId];
                if (player && player.id) {
                    const cards = player.cards || [];
                    const unmarkedCards = calculateUnmarkedCards(cards, revealedNumbers);
                    messages.push(`ã€${player.nickname}ã€‘å‰©é¤˜ç‰Œï¼š${unmarkedCards} å¼µ`);
                }
            }

            if (messages.length > 0) {
                const separator = " ğŸŒŸ ";
                let content = messages.join(separator);
                content = "ğŸ† ç•¶å‰ç‰Œå±€é€²åº¦: " + content + separator + content + separator + content + separator;
                marqueeTextEl.textContent = content;
            } else {
                marqueeTextEl.textContent = "ğŸ± éŠæˆ²å·²é–‹å§‹ï¼Œç­‰å¾…ç©å®¶åŠ å…¥æˆ–ç™¼ç‰Œ...";
            }
        }

        function toggleNumber(n) {
            if (!gameState) return;
            const numbers = Array.isArray(gameState.revealedNumbers) ? [...gameState.revealedNumbers] : [];
            if (numbers.includes(n)) numbers.splice(numbers.indexOf(n), 1);
            else numbers.push(n);
            updateDoc(roomRef, { revealedNumbers: numbers, updatedAt: serverTimestamp() })
                .catch(e => console.log('toggleNumber err', e));
        }

        function renderBallButtons() {
            ballButtonsEl.innerHTML = '';
            for (let n = 1; n <= 13; n++) {
                const btn = document.createElement('button');
                btn.className = 'ball-btn';
                btn.textContent = n;
                if (n === 1 || n === 9) btn.classList.add('ball-yellow');
                else if (n === 2 || n === 10) btn.classList.add('ball-blue');
                else if (n === 3 || n === 11) btn.classList.add('ball-red');
                else if (n === 4 || n === 12) btn.classList.add('ball-purple');
                else if (n === 5 || n === 13) btn.classList.add('ball-orange');
                else if (n === 6) btn.classList.add('ball-green');
                else if (n === 7) btn.classList.add('ball-maroon');
                else if (n === 8) btn.classList.add('ball-black');
                if (n >= 9 && n <= 13) { btn.classList.add('ball-stripe'); }
                if (gameState.revealedNumbers && gameState.revealedNumbers.includes(n)) btn.classList.add('selected');
                btn.onclick = () => { toggleNumber(n); };
                ballButtonsEl.appendChild(btn);
            }
        }

        btnJoin.addEventListener('click', async () => {
            if (!currentUser) { setStatus('å°šæœªç™»å…¥'); return; }
            const nickInput = (nicknameInput.value || '').trim(); if (!nickInput) { setStatus('è«‹å…ˆè¼¸å…¥æš±ç¨±'); return; }
            const isKai = nickInput === 'Kai';
            try {
                const snap = await getDoc(roomRef);
                if (!snap.exists()) {
                    const players = {}; players[currentUser.uid] = { id: currentUser.uid, nickname: isKai ? 'Kai' : nickInput, cards: [] };
                    const docData = { players, gameStarted: false, notice: isKai ? 'æˆ¿ä¸» Kai å·²å»ºç«‹æˆ¿é–“' : 'æˆ¿é–“å·²å»ºç«‹', updatedAt: serverTimestamp(), deck: [], revealedNumbers: [] };
                    if (isKai) docData.creatorId = currentUser.uid;
                    await setDoc(roomRef, docData);
                    myNickname = isKai ? 'Kai' : nickInput; nicknameInput.value = isKai ? '' : nickInput; setStatus(isKai ? 'å·²ä»¥ Kai å»ºç«‹æˆ¿é–“' : 'æˆ¿é–“å»ºç«‹'); return;
                } else {
                    const data = snap.data(); const players = data.players || {};
                    const realCount = Object.values(players).filter(p => p && p.id).length; if (realCount >= MAX_PLAYERS) { setStatus('æˆ¿é–“å·²æ»¿'); return; }
                    players[currentUser.uid] = { id: currentUser.uid, nickname: nickInput, cards: [] };
                    await updateDoc(roomRef, { players, updatedAt: serverTimestamp() });
                    myNickname = nickInput; nicknameInput.value = '';
                }
            } catch (e) { console.log('join err', e); setStatus('åŠ å…¥å¤±æ•—'); }
        });

        btnLeave.addEventListener('click', async () => {
            if (!currentUser) return;
            try {
                const snap = await getDoc(roomRef);
                if (!snap.exists()) return;
                const data = snap.data(); const players = data.players || {};
                if (players[currentUser.uid]) delete players[currentUser.uid];
                await updateDoc(roomRef, { players, updatedAt: serverTimestamp() });
            } catch (e) { console.log('leave err', e); }
        });

        btnStart.addEventListener('click', async () => {
            if (!gameState) return;
            let deck = shuffle(buildDeck());
            const players = Object.keys(gameState.players || {});
            const dealCards = {};
            for (const pid of players) { dealCards[pid] = deck.splice(0, CARDS_PER_PLAYER).map(c => c.code); }
            try {
                await updateDoc(roomRef, {
                    gameStarted: true,
                    deck: deck.map(c => c.code),
                    players: Object.fromEntries(players.map(pid => [pid, { ...gameState.players[pid], cards: dealCards[pid] }])),
                    revealedNumbers: [],
                    updatedAt: serverTimestamp()
                });
            } catch (e) { console.log('start err', e); }
        });

        btnRestart.addEventListener('click', async () => {
            if (!gameState) return;
            try { await updateDoc(roomRef, { gameStarted: false, deck: [], revealedNumbers: [], players: {}, updatedAt: serverTimestamp() }); } catch (e) { console.log('restart err', e); }
        });

        async function foulDrawFor(playerId) {
            if (!currentUser || currentUser.uid !== playerId) return;
            if (!gameState) return;
            const deck = gameState.deck || [];
            if (deck.length === 0) { alert('ç‰Œå †å·²ç©ºï¼Œç„¡æ³•æŠ½ç‰Œ'); return; }
            const drawnCard = deck[0]; // å–ç¬¬ä¸€å¼µç‰Œ
            const playerCards = gameState.players[playerId]?.cards || [];
            playerCards.push(drawnCard);

            try {
                await runTransaction(db, async (t) => {
                    const snap = await t.get(roomRef);
                    if (!snap.exists()) throw 'æˆ¿é–“ä¸å­˜åœ¨';
                    const data = snap.data();
                    const deckNow = data.deck || [];
                    if (deckNow.length === 0) throw 'ç‰Œå·²æŠ½å®Œ';
                    t.update(roomRef, {
                        [`players.${playerId}.cards`]: playerCards,
                        deck: deckNow.slice(1),
                        updatedAt: serverTimestamp()
                    });
                });
            } catch (e) { console.log('foulDraw transaction err', e); alert('æŠ½ç‰Œå¤±æ•—'); }
        }

        function renderUI() {
            if (!gameState) { joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); return; }
            joinPanel.classList.add('hidden'); roomPanel.classList.remove('hidden');
            const players = gameState.players || {};
            const playerIds = Object.keys(players || {});
            roomOwnerEl.textContent = gameState.creatorId ? players[gameState.creatorId]?.nickname || 'â€”' : 'â€”';
            roomCountEl.textContent = playerIds.length + ' / ' + MAX_PLAYERS;
            if (players[currentUser.uid]) {
                myNickname = players[currentUser.uid].nickname || '';
                myNickEl.textContent = myNickname;
            } else {
                myNickEl.textContent = 'â€”';
            }
            btnStart.style.display = (gameState.creatorId === currentUser.uid) ? 'inline-block' : 'none';
            btnRestart.style.display = (gameState.creatorId === currentUser.uid) ? 'inline-block' : 'none';
            noticeEl.textContent = gameState.notice || '';

            renderBallButtons();
            updateMarquee();

            playersArea.innerHTML = '';

            // å…ˆæŠŠç©å®¶è½‰æˆé™£åˆ—ï¼Œä¸¦è¨ˆç®—å‰©é¤˜æœªæ­ç‰Œæ•¸
            const playersArr = Object.values(players).map(p => {
                const unmarkedCount = calculateUnmarkedCards(p.cards || [], gameState.revealedNumbers || []);
                return { ...p, unmarkedCount };
            });

            // è‡ªå·±æ’æœ€ä¸Šé¢
            const me = playersArr.find(p => p.id === currentUser.uid);
            const others = playersArr.filter(p => p.id !== currentUser.uid);

            // å…¶ä»–ç©å®¶ä¾å‰©é¤˜ç‰Œæ•¸ç”±å°‘åˆ°å¤šæ’åº
            others.sort((a, b) => a.unmarkedCount - b.unmarkedCount);

            // çµ„åˆæ’åºå¾Œçš„é™£åˆ—
            const sortedPlayers = me ? [me, ...others] : others;

            // æ¸²æŸ“ç©å®¶
            for (const player of sortedPlayers) {
                const pid = player.id;
                const div = document.createElement('div'); div.className = 'p-2 rounded bg-slate-800 border border-slate-700';
                const header = document.createElement('div'); header.className = 'player-header';
                const nameDiv = document.createElement('div'); nameDiv.textContent = player.nickname;
                header.appendChild(nameDiv);

                const foulBtn = document.createElement('button');
                foulBtn.textContent = 'çŠ¯è¦æŠ½ç‰Œ';
                foulBtn.className = 'foul-btn';
                if (currentUser.uid !== pid) foulBtn.disabled = true;
                foulBtn.onclick = () => foulDrawFor(pid);
                header.appendChild(foulBtn);

                div.appendChild(header);

                const cardsDiv = document.createElement('div'); cardsDiv.className = 'mt-2 flex flex-wrap gap-1';
                const revealedNumbers = gameState.revealedNumbers || [];
                for (const c of player.cards) {
                    const rank = getCardRank(c);
                    const isMine = currentUser.uid === pid;
                    const isRevealed = revealedNumbers.includes(rank);
                    const showFace = isMine || isRevealed;

                    const cardEl = document.createElement('div');
                    cardEl.className = 'card ' + (showFace ? 'card-face' : 'card-back');

                    // ç´…é»‘èŠ±è‰²
                    if (c) {
                        if (c[0] === 'â™¥' || c[0] === 'â™¦') cardEl.classList.add('suit-red');
                        else cardEl.classList.add('suit-black');
                        cardEl.textContent = showFace ? c : '';
                    } else {
                        cardEl.textContent = ''; // è“‹ç‰Œä¸é¡¯ç¤º ?
                    }
                    
                    // é»ƒæ¡†æ¨™è¨»
                    if (currentUser.uid === pid && revealedNumbers.includes(rank)) {
                        cardEl.classList.add('marked');
                    }
                    cardsDiv.appendChild(cardEl);
                }

                div.appendChild(cardsDiv);
                playersArea.appendChild(div);
            }

        }

        doAnonymousAuth();
    </script>
</body>

</html>
