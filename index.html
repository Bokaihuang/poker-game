<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pool Poker — main-room (with Foul draw + Number Buttons)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#071024; color:#e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .card { width:54px; height:74px; border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.6); }
    .card-back { background:linear-gradient(180deg,#0b1220,#081228); border:2px solid rgba(255,255,255,.04); color:transparent; }
    .card-face { background:white; color:#071024; border:2px solid rgba(2,6,23,.06); }
    .marked { outline:3px solid #f59e0b; transform:scale(1.05); }
    .small { font-size:.85rem; color:#cfe8ff; }
    .suit-red { color:#dc2626; }
    .suit-black { color:#111827; }
    .foul-btn { background:#ef4444; color:white; padding:6px 8px; border-radius:6px; font-weight:600; cursor:pointer; border:none; }
    .foul-btn[disabled] { opacity:0.5; cursor:not-allowed; }
    .player-header { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .number-buttons button { transition: all 0.2s; }
    .number-buttons button:hover { transform: scale(1.1); background:#888; }
  </style>
</head>
<body>
<div class="max-w-5xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Pool Poker — main-room</h1>

  <div id="status" class="mb-4 text-sm small">初始化中…（請開 Console 查看）</div>

  <!-- Nick input -->
  <div id="joinPanel" class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
    <div class="col-span-2">
      <label class="small">暱稱</label>
      <input id="nickname" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="輸入暱稱" />
    </div>
    <div>
      <button id="btnJoin" class="w-full py-2 rounded bg-emerald-600 hover:bg-emerald-500">加入房間</button>
    </div>
  </div>

  <!-- Room UI -->
  <div id="roomPanel" class="mb-6 p-4 rounded bg-slate-900 border border-slate-700 hidden">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-xs small">房間 ID</div>
        <div class="font-mono">main-room</div>
      </div>
      <div>
        <div class="text-xs small">房主</div>
        <div id="roomOwner" class="font-bold">—</div>
      </div>
      <div>
        <div class="text-xs small">人數</div>
        <div id="roomCount">0 / 5</div>
      </div>
      <div>
        <div class="text-xs small">我的暱稱</div>
        <div id="myNick" class="font-mono">—</div>
      </div>
    </div>

    <div class="flex gap-2 items-center mb-4">
      <button id="btnStart" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-500 hidden">發牌（房主）</button>
      <button id="btnRestart" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 hidden">重開（房主）</button>
      <button id="btnLeave" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 ml-auto">退出房間</button>
      <div id="notice" class="ml-4 small text-slate-300"></div>
    </div>

    <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

  <div id="debug" class="mt-6 p-3 rounded bg-slate-900 border border-slate-700 text-xs small">
    <div><strong>Debug (console)</strong></div>
    <pre id="log" class="text-xs mt-2"></pre>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc,
    deleteDoc, serverTimestamp, arrayUnion, runTransaction
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const EXTERNAL_FIREBASE_CONFIG = {
    apiKey: "YOUR_API_KEY_HERE",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_ID",
    appId: "YOUR_APP_ID"
  };

  const APP_ID = EXTERNAL_FIREBASE_CONFIG.projectId;
  const ROOM_PATH = `artifacts/${APP_ID}/public/data/pool_poker_rooms/main_room`;
  const CARDS_PER_PLAYER = 8;
  const MAX_PLAYERS = 5;
  const MAX_EXTRA = 6;

  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const nicknameInput = document.getElementById('nickname');
  const btnJoin = document.getElementById('btnJoin');
  const joinPanel = document.getElementById('joinPanel');
  const roomPanel = document.getElementById('roomPanel');
  const roomOwnerEl = document.getElementById('roomOwner');
  const roomCountEl = document.getElementById('roomCount');
  const playersArea = document.getElementById('playersArea');
  const myNickEl = document.getElementById('myNick');
  const btnStart = document.getElementById('btnStart');
  const btnRestart = document.getElementById('btnRestart');
  const btnLeave = document.getElementById('btnLeave');
  const noticeEl = document.getElementById('notice');

  const app = initializeApp(EXTERNAL_FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const roomRef = doc(db, ROOM_PATH);

  let currentUser = null;
  let gameState = null;
  let myNickname = '';

  function log(...args) { console.log(...args); logEl.textContent += args.join(' ') + "\n"; logEl.scrollTop = logEl.scrollHeight; }
  function setStatus(s) { statusEl.textContent = s; }

  async function doAnonymousAuth() {
    setStatus('使用匿名登入 Firebase...');
    try { await signInAnonymously(auth); } catch (e) { setStatus('Auth 失敗'); log(e); }
  }

  onAuthStateChanged(auth, (user) => { currentUser = user; if(user){ setStatus('已登入'); subscribeRoom(); } else { setStatus('未登入'); } });

  let unsubscribe = null;
  function subscribeRoom() {
    if (unsubscribe) return;
    unsubscribe = onSnapshot(roomRef, (snap) => {
      gameState = snap.exists()? snap.data(): null;
      renderUI();
    });
  }

  const suits = ['♣','♦','♥','♠'];
  const rankMap = {1:'A',11:'J',12:'Q',13:'K'};
  function buildDeck(){
    const deck = [];
    for (let r=1;r<=13;r++){
      for (let s=0;s<4;s++){
        const rank = rankMap[r] || String(r);
        deck.push({suit: suits[s], rank, code: `${suits[s]}${rank}`});
      }
    }
    return deck;
  }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

  // join, leave, start, restart, markCard, foulDrawFor 保留原始邏輯（略去為簡化）

  function renderUI() {
    const players = (gameState && gameState.players) ? gameState.players : {};
    const cleanPlayers = {};
    Object.keys(players).forEach(k => { if(players[k]?.id) cleanPlayers[k]=players[k]; });
    if(!gameState){ joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); return; }

    const amInRoom = currentUser && cleanPlayers[currentUser.uid];
    if(!amInRoom){ joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); return; }

    joinPanel.classList.add('hidden'); roomPanel.classList.remove('hidden');
    myNickname = cleanPlayers[currentUser.uid].nickname || myNickname;
    myNickEl.textContent = myNickname;
    roomOwnerEl.textContent = cleanPlayers[gameState.creatorId]?.nickname || '—';
    roomCountEl.textContent = `${Object.keys(cleanPlayers).length} / ${MAX_PLAYERS}`;
    noticeEl.textContent = gameState.notice || '';

    const amHost = gameState.creatorId === currentUser.uid && myNickname === 'kai';
    btnStart.classList.toggle('hidden', !amHost);
    btnRestart.classList.toggle('hidden', !amHost);

    playersArea.innerHTML = '';
    const pList = Object.values(cleanPlayers).sort((a,b)=>(a.id===currentUser.uid?-1:(b.id===currentUser.uid?1:0)));

    pList.forEach(p=>{
      const wrapper = document.createElement('div');
      wrapper.className='p-3 rounded bg-slate-800 border border-slate-700';

      const header = document.createElement('div'); header.className='player-header mb-2';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${p.nickname || 'p_'+p.id.slice(0,6)}</strong>${p.id===currentUser.uid?'<span class="small"> (您)</span>':''}`;

      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
      const countSpan = document.createElement('div'); countSpan.className='small'; countSpan.textContent=`牌 ${(p.cards||[]).length} / ${CARDS_PER_PLAYER+MAX_EXTRA}`;

      const foulBtn=document.createElement('button'); foulBtn.className='foul-btn'; foulBtn.textContent='犯規 +1';
      foulBtn.disabled = !gameState.gameStarted || (p.cards||[]).length >= CARDS_PER_PLAYER+MAX_EXTRA || !Array.isArray(gameState.deck) || gameState.deck.length===0;
      foulBtn.onclick=()=>{ if(p.id===currentUser.uid) console.log('點擊自己犯規抽牌'); else setStatus('只能為自己按犯規'); };

      right.append(countSpan,foulBtn);
      header.append(left,right);
      wrapper.appendChild(header);

      // number buttons 1~13
      const btnContainer = document.createElement('div');
      btnContainer.className='number-buttons mb-2 flex flex-wrap gap-1';
      for(let n=1;n<=13;n++){
        const btn=document.createElement('button');
        btn.textContent=n;
        btn.style.width='32px'; btn.style.height='32px'; btn.style.borderRadius='50%';
        btn.style.border='1px solid #ccc'; btn.style.background='#555'; btn.style.color='white'; btn.style.fontWeight='bold'; btn.style.cursor='pointer';
        btn.onclick=()=>{ console.log(`玩家 ${p.nickname} 按下號碼 ${n}`); };
        btnContainer.appendChild(btn);
      }
      wrapper.appendChild(btnContainer);

      const cardsRow=document.createElement('div'); cardsRow.className='flex gap-2 flex-wrap';
      const cards = p.cards||[];
      cards.forEach(c=>{
        const cardEl=document.createElement('div'); cardEl.className='card';
        const isMine = p.id===currentUser.uid;
        const isMarked = (p.marked||[]).includes(c);
        if(isMarked) cardEl.classList.add('marked');
        if(isMine){ cardEl.classList.add('card-face'); cardEl.textContent=c; cardEl.style.cursor='pointer'; cardEl.title=isMarked?'已標記':'點擊以標記'; if(c[0]==='♥'||c[0]==='♦') cardEl.classList.add('suit-red'); else cardEl.classList.add('suit-black'); }
        else{ cardEl.classList.add('card-back'); cardEl.textContent=' '; }
        cardsRow.appendChild(cardEl);
      });
      wrapper.appendChild(cardsRow);
      playersArea.appendChild(wrapper);
    });
  }

  (async()=>{ await doAnonymousAuth(); })();
</script>
</body>
</html>


