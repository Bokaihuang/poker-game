<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pool Poker — main-room (with Number Buttons)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#071024; color:#e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .card { width:54px; height:74px; border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.6); }
    .card-back { background:linear-gradient(180deg,#0b1220,#081228); border:2px solid rgba(255,255,255,.04); color:transparent; }
    .card-face { background:white; color:#071024; border:2px solid rgba(2,6,23,.06); }
    .marked { outline:3px solid #f59e0b; transform:scale(1.05); }
    .small { font-size:.85rem; color:#cfe8ff; }
    .suit-red { color:#dc2626; } /* diamonds/hearts */
    .suit-black { color:#111827; } /* clubs/spades */
    .foul-btn { background:#ef4444; color:white; padding:6px 8px; border-radius:6px; font-weight:600; cursor:pointer; border:none; }
    .foul-btn[disabled] { opacity:0.5; cursor:not-allowed; }
    .player-header { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .number-btn { width:28px; height:28px; border-radius:50%; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; margin:2px; border:none; }
    .number-btn.yellow { background:#facc15; color:#071024; }
    .number-btn.blue { background:#3b82f6; color:white; }
    .number-btn.gray { background:#6b7280; color:white; }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Pool Poker — main-room</h1>
    <div id="status" class="mb-4 text-sm small">初始化中…（請開 Console 查看）</div>

    <div id="joinPanel" class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="col-span-2">
        <label class="small">暱稱</label>
        <input id="nickname" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="輸入暱稱" />
      </div>
      <div>
        <button id="btnJoin" class="w-full py-2 rounded bg-emerald-600 hover:bg-emerald-500">加入房間</button>
      </div>
    </div>

    <div id="roomPanel" class="mb-6 p-4 rounded bg-slate-900 border border-slate-700 hidden">
      <div class="flex items-center justify-between mb-3">
        <div><div class="text-xs small">房間 ID</div><div class="font-mono">main-room</div></div>
        <div><div class="text-xs small">房主</div><div id="roomOwner" class="font-bold">—</div></div>
        <div><div class="text-xs small">人數</div><div id="roomCount">0 / 5</div></div>
        <div><div class="text-xs small">我的暱稱</div><div id="myNick" class="font-mono">—</div></div>
      </div>

      <div class="flex gap-2 items-center mb-4">
        <button id="btnStart" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-500 hidden">發牌（房主）</button>
        <button id="btnRestart" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 hidden">重開（房主）</button>
        <button id="btnLeave" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 ml-auto">退出房間</button>
        <div id="notice" class="ml-4 small text-slate-300"></div>
      </div>

      <div id="numberButtons" class="mb-4"></div>
      <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <div id="debug" class="mt-6 p-3 rounded bg-slate-900 border border-slate-700 text-xs small">
      <div><strong>Debug (console)</strong></div>
      <pre id="log" class="text-xs mt-2"></pre>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, deleteDoc, serverTimestamp, arrayUnion, deleteField, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const EXTERNAL_FIREBASE_CONFIG = { 
      apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0",
      authDomain: "poolpokergame-b88ed.firebaseapp.com",
      projectId: "poolpokergame-b88ed",
      storageBucket: "poolpokergame-b88ed.firebasestorage.app",
      messagingSenderId: "574863840102",
      appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
    };

  const APP_ID = EXTERNAL_FIREBASE_CONFIG.projectId;
    const ROOM_PATH = `artifacts/${APP_ID}/public/data/pool_poker_rooms/main_room`;
    const CARDS_PER_PLAYER = 8;
    const MAX_PLAYERS = 5;
    const MAX_EXTRA = 6;

    const statusEl=document.getElementById('status'), logEl=document.getElementById('log');
    const nicknameInput=document.getElementById('nickname'), btnJoin=document.getElementById('btnJoin'), joinPanel=document.getElementById('joinPanel'), roomPanel=document.getElementById('roomPanel');
    const roomOwnerEl=document.getElementById('roomOwner'), roomCountEl=document.getElementById('roomCount'), playersArea=document.getElementById('playersArea'), myNickEl=document.getElementById('myNick');
    const btnStart=document.getElementById('btnStart'), btnRestart=document.getElementById('btnRestart'), btnLeave=document.getElementById('btnLeave'), noticeEl=document.getElementById('notice');
    const numberButtonsEl = document.getElementById('numberButtons');

    const app = initializeApp(EXTERNAL_FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const roomRef = doc(db, ROOM_PATH);

    let currentUser=null, gameState=null, myNickname='';

    function log(...args){console.log(...args); logEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' ')+"\n"; logEl.scrollTop=logEl.scrollHeight;}
    function setStatus(s){statusEl.textContent=s;}

    async function doAnonymousAuth(){try{const cred=await signInAnonymously(auth); log('signed in uid=',cred.user.uid);}catch(e){log('auth failed',e); setStatus('Auth 失敗');}}
    onAuthStateChanged(auth,user=>{currentUser=user;if(user){setStatus('已登入：'+user.uid); subscribeRoom();}else{setStatus('未登入');}});

    let unsubscribe=null;
    function subscribeRoom(){if(unsubscribe) return; unsubscribe=onSnapshot(roomRef,snap=>{if(!snap.exists()){gameState=null; renderUI(); setStatus('房間尚未建立'); return;} gameState=snap.data(); renderUI(); setStatus('已連到房間');},err=>{log('snapshot err',err); setStatus('訂閱失敗：'+(err.message||err));});}

    const suits=['♣','♦','♥','♠']; const rankMap={1:'A',11:'J',12:'Q',13:'K'};
    function buildDeck(){const deck=[];for(let r=1;r<=13;r++){for(let s=0;s<4;s++){const rank=rankMap[r]||String(r); deck.push({suit:suits[s], rank, code:`${suits[s]}${rank}`});}}return deck;}
    function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}

    btnJoin.addEventListener('click', async()=>{
      if(!currentUser){setStatus('尚未登入');return;} const nickInput=(nicknameInput.value||'').trim(); if(!nickInput){setStatus('請先輸入暱稱');return;}
      const isKai = nickInput==='kai';
      try{
        const snap = await getDoc(roomRef);
        if(!snap.exists()){
          const players={}; players[currentUser.uid]={id:currentUser.uid,nickname:isKai?'kai':nickInput,cards:[],marked:[]};
          const docData={players,gameStarted:false,notice:isKai?'房主 kai 已建立房間':'房間已建立，等待 kai 成為房主',updatedAt:serverTimestamp(),deck:[],revealedNumbers:[]};
          if(isKai) docData.creatorId=currentUser.uid;
          await setDoc(roomRef,docData);
          myNickname=isKai?'kai':nickInput; nicknameInput.value=isKai?'':nickInput;
          setStatus(isKai?'已以 kai 建立並加入房間（您為房主）':'房間建立並加入'); log('created room',currentUser.uid,myNickname); return;
        }else{
          const data = snap.data(); const players = data.players||{};
          const realCount=Object.values(players).filter(p=>p&&p.id).length;
          if(realCount>=MAX_PLAYERS){setStatus('房間已滿');return;}
          if(players[currentUser.uid]&&players[currentUser.uid].id){setStatus('您已在房間中');return;}
          const updateObj={updatedAt:serverTimestamp()}; updateObj[`players.${currentUser.uid}`]={id:currentUser.uid,nickname:isKai?'kai':nickInput,cards:[],marked:[]};
          if(isKai){updateObj['creatorId']=currentUser.uid; updateObj['notice']='kai 已成為房主'; myNickname='kai'; nicknameInput.value='';}else{myNickname=nickInput;}
          await updateDoc(roomRef,updateObj); setStatus('已加入房間'); log('joined',currentUser.uid,myNickname);
        }
      }catch(e){log('join err',e); setStatus('加入失敗：'+(e.message||e));}
    });

    btnLeave.addEventListener('click', async()=>{
      if(!currentUser) return;
      try{
        if(gameState && gameState.creatorId===currentUser.uid && myNickname==='kai'){await deleteDoc(roomRef); setStatus('房主已退出，房間已刪除'); log('host deleted room'); return;}
        await updateDoc(roomRef,{[`players.${currentUser.uid}`]:deleteField(),updatedAt:serverTimestamp()}); setStatus('已退出房間'); myNickname='';
      }catch(e){log('leave err',e); setStatus('退出失敗：'+(e.message||e));}
    });

    btnStart.addEventListener('click', async()=>{
      if(!currentUser||!gameState) return; if(gameState.creatorId!==currentUser.uid||myNickname!=='kai'){setStatus('只有 kai 房主可以發牌');return;}
      try{
        const players=gameState.players||{}; const pids=Object.keys(players).filter(k=>players[k]&&players[k].id);
        if(pids.length===0){setStatus('沒有玩家');return;}
        if(pids.length>MAX_PLAYERS){setStatus('人數超過上限');return;}
        let deckObj=buildDeck().map(c=>c.code); shuffle(deckObj);
        const updateObj={gameStarted:true,notice:'遊戲開始：已發牌',updatedAt:serverTimestamp()};
        pids.forEach((pid,idx)=>{ const start=idx*CARDS_PER_PLAYER; const hand=deckObj.slice(start,start+CARDS_PER_PLAYER); updateObj[`players.${pid}.cards`]=hand; updateObj[`players.${pid}.marked`]=[];});
        const remainingDeck = deckObj.slice(pids.length*CARDS_PER_PLAYER); updateObj['deck']=remainingDeck; updateObj['revealedNumbers']=[]; // 清空揭示
        await updateDoc(roomRef,updateObj); setStatus('發牌完成'); log('deck remaining',remainingDeck.length);
      }catch(e){log('start err',e); setStatus('發牌失敗：'+(e.message||e));}
    });

    btnRestart.addEventListener('click', async()=>{
      if(!currentUser||!gameState) return; if(gameState.creatorId!==currentUser.uid||myNickname!=='kai'){setStatus('只有 kai 房主可以重開');return;}
      try{
        const players=gameState.players||{}; const updateObj={gameStarted:false,notice:'房主已重開遊戲',updatedAt:serverTimestamp()}; 
        Object.keys(players).forEach(pid=>{if(players[pid]&&players[pid].id){updateObj[`players.${pid}.cards`]=[]; updateObj[`players.${pid}.marked`]=[];}});
        updateObj['deck']=[]; updateObj['revealedNumbers']=[]; await updateDoc(roomRef,updateObj); setStatus('已重開');
      }catch(e){log('restart err',e); setStatus('重開失敗：'+(e.message||e));}
    });

    async function markCard(pid,cardCode){
      if(!currentUser||!gameState) return; if(!gameState.gameStarted){setStatus('遊戲尚未開始');return;} if(pid!==currentUser.uid){setStatus('只能標記自己的卡');return;}
      try{await updateDoc(roomRef,{[`players.${currentUser.uid}.marked`]:arrayUnion(cardCode), updatedAt:serverTimestamp()}); setStatus('已標記 '+cardCode);}
      catch(e){log('mark err',e); setStatus('標記失敗：'+(e.message||e));}
    }

    async function foulDrawFor(playerId){
      if(!currentUser) return;
      try{await runTransaction(db,async(tx)=>{const snap=await tx.get(roomRef); if(!snap.exists()) throw new Error('房間不存在');
        const data = snap.data(); const deck = Array.isArray(data.deck)?[...data.deck]:[]; const players = data.players||{}; const target=players[playerId];
        if(!target||!target.id) throw new Error('玩家不存在'); const currentCount=Array.isArray(target.cards)?target.cards.length:0;
        if(currentCount>=CARDS_PER_PLAYER+MAX_EXTRA) throw new Error('此玩家已達最多 14 張'); if(deck.length===0) throw new Error('剩餘牌已經抽完');
        const drawn=deck.pop(); const newPlayers={...players,[playerId]:{...target,cards:[...(target.cards||[]),drawn]}};
        tx.update(roomRef,{players:newPlayers,deck:deck,updatedAt:serverTimestamp()});
      }); setStatus('犯規抽牌成功');} catch(e){log('foul draw err',e); setStatus('犯規抽牌失敗：'+(e.message||e));}
    }

    // ------------------ Number Buttons ------------------
    function toggleNumber(n){
      if(!currentUser||!gameState) return;
      runTransaction(db, async(tx)=>{
        const snap=await tx.get(roomRef); if(!snap.exists()) throw new Error('房間不存在');
        const data = snap.data(); const current = Array.isArray(data.revealedNumbers)?[...data.revealedNumbers]:[];
        const idx = current.indexOf(n);
        if(idx>=0) current.splice(idx,1); else current.push(n);
        tx.update(roomRef,{revealedNumbers:current,updatedAt:serverTimestamp()});
      }).catch(e=>log('toggleNumber err',e));
    }

    function renderNumberButtons(){
      numberButtonsEl.innerHTML='';
      for(let n=1;n<=13;n++){
        const btn=document.createElement('button'); btn.textContent=n; btn.className='number-btn';
        if(n===1||n===9) btn.classList.add('yellow'); else if(n===2||n===10) btn.classList.add('blue'); else btn.classList.add('gray');
        btn.onclick=()=>toggleNumber(n); numberButtonsEl.appendChild(btn);
      }
    }

    function renderUI(){
      renderNumberButtons();
      const players=(gameState&&gameState.players)?gameState.players:{};
      const cleanPlayers={}; Object.keys(players).forEach(k=>{if(players[k]&&players[k].id) cleanPlayers[k]=players[k];});
      if(!gameState){joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); myNickEl.textContent='—'; return;}
      const amInRoom=currentUser&&cleanPlayers[currentUser.uid]; if(!amInRoom){joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); roomOwnerEl.textContent=cleanPlayers[gameState.creatorId]?.nickname||'—'; roomCountEl.textContent=`${Object.keys(cleanPlayers).length} / ${MAX_PLAYERS}`; return;}
      joinPanel.classList.add('hidden'); roomPanel.classList.remove('hidden'); myNickname=cleanPlayers[currentUser.uid].nickname||myNickname; myNickEl.textContent=myNickname;
      const ownerNick=cleanPlayers[gameState.creatorId]?.nickname||'—'; roomOwnerEl.textContent=ownerNick; roomCountEl.textContent=`${Object.keys(cleanPlayers).length} / ${MAX_PLAYERS}`;
      btnStart.style.display=(gameState.creatorId===currentUser.uid&&myNickname==='kai'&&!gameState.gameStarted)?'inline-block':'none';
      btnRestart.style.display=(gameState.creatorId===currentUser.uid&&myNickname==='kai')?'inline-block':'none';
      noticeEl.textContent=gameState.notice||'';

      // 渲染玩家手牌
      playersArea.innerHTML='';
      const revealedNumbers = Array.isArray(gameState.revealedNumbers)?gameState.revealedNumbers:[];
      Object.values(cleanPlayers).forEach(p=>{
        const cardWrapper=document.createElement('div'); cardWrapper.className='p-2 rounded bg-slate-800';
        const header=document.createElement('div'); header.className='player-header';
        header.innerHTML=`<span>${p.nickname}</span>`;
        if(currentUser.uid===p.id){const foulBtn=document.createElement('button'); foulBtn.className='foul-btn'; foulBtn.textContent='犯規抽牌'; foulBtn.onclick=()=>foulDrawFor(p.id); header.appendChild(foulBtn);}
        cardWrapper.appendChild(header);
        const cardsRow=document.createElement('div'); cardsRow.className='flex flex-wrap gap-1 mt-1';
        const cards=p.cards||[];
        cards.forEach(c=>{
          const cardEl=document.createElement('div'); cardEl.className='card';
          const cardNumber = c.slice(1) === 'A' ? 1 : parseInt(c.slice(1)); // 取數字
          const revealed = revealedNumbers.includes(cardNumber);
          if(revealed) cardEl.classList.add('card-face'); else cardEl.classList.add('card-back');
          if(revealed && p.id===currentUser.uid) cardEl.classList.add('marked');
          if(p.marked && p.marked.includes(c)) cardEl.classList.add('marked');
          cardEl.textContent=revealed?c:'';
          if(revealed) cardEl.classList.add((c[0]==='♥'||c[0]==='♦')?'suit-red':'suit-black');
          cardsRow.appendChild(cardEl);
        });
        cardWrapper.appendChild(cardsRow);
        playersArea.appendChild(cardWrapper);
      });
    }
  </script>
</body>
</html>
