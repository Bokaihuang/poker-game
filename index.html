<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pool Poker — main-room (with Foul draw & Number Buttons)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#071024; color:#e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .card { width:54px; height:74px; border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.6); }
    .card-back { background:linear-gradient(180deg,#0b1220,#081228); border:2px solid rgba(255,255,255,.04); color:transparent; }
    .card-face { background:white; color:#071024; border:2px solid rgba(2,6,23,.06); }
    .marked { outline:3px solid #f59e0b; transform:scale(1.05); }
    .small { font-size:.85rem; color:#cfe8ff; }
    .suit-red { color:#dc2626; } /* diamonds/hearts */
    .suit-black { color:#111827; } /* clubs/spades */
    .foul-btn { background:#ef4444; color:white; padding:6px 8px; border-radius:6px; font-weight:600; cursor:pointer; border:none; }
    .foul-btn[disabled] { opacity:0.5; cursor:not-allowed; }
    .player-header { display:flex; gap:8px; align-items:center; justify-content:space-between; }

    /* Number Buttons */
    #numberButtons { display:flex; flex-wrap:wrap; gap:2px; margin-bottom:8px; }
    .number-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid #ccc;
      color: #000;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .number-btn.active {
      outline: 3px solid #f59e0b;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Pool Poker — main-room</h1>

    <div id="status" class="mb-4 text-sm small">初始化中…（請開 Console 查看）</div>

    <!-- Nick input (before join) -->
    <div id="joinPanel" class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="col-span-2">
        <label class="small">暱稱</label>
        <input id="nickname" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="輸入暱稱" />
      </div>
      <div>
        <button id="btnJoin" class="w-full py-2 rounded bg-emerald-600 hover:bg-emerald-500">加入房間</button>
      </div>
    </div>

    <!-- Room UI -->
    <div id="roomPanel" class="mb-6 p-4 rounded bg-slate-900 border border-slate-700 hidden">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-xs small">房間 ID</div>
          <div class="font-mono">main-room</div>
        </div>
        <div>
          <div class="text-xs small">房主</div>
          <div id="roomOwner" class="font-bold">—</div>
        </div>
        <div>
          <div class="text-xs small">人數</div>
          <div id="roomCount">0 / 5</div>
        </div>
        <div>
          <div class="text-xs small">我的暱稱</div>
          <div id="myNick" class="font-mono">—</div>
        </div>
      </div>

      <!-- Number Buttons -->
      <div id="numberButtons"></div>

      <div class="flex gap-2 items-center mb-4">
        <button id="btnStart" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-500 hidden">發牌（房主）</button>
        <button id="btnRestart" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 hidden">重開（房主）</button>
        <button id="btnLeave" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 ml-auto">退出房間</button>
        <div id="notice" class="ml-4 small text-slate-300"></div>
      </div>

      <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <div id="debug" class="mt-6 p-3 rounded bg-slate-900 border border-slate-700 text-xs small">
      <div><strong>Debug (console)</strong></div>
      <pre id="log" class="text-xs mt-2"></pre>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc,
      deleteDoc, serverTimestamp, arrayUnion, deleteField, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- CONFIG ----------
    const EXTERNAL_FIREBASE_CONFIG = { /* ...保持原設定... */ };
    const APP_ID = EXTERNAL_FIREBASE_CONFIG.projectId;
    const ROOM_PATH = `artifacts/${APP_ID}/public/data/pool_poker_rooms/main_room`;
    const CARDS_PER_PLAYER = 8;
    const MAX_PLAYERS = 5;
    const MAX_EXTRA = 6;

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const nicknameInput = document.getElementById('nickname');
    const btnJoin = document.getElementById('btnJoin');
    const joinPanel = document.getElementById('joinPanel');
    const roomPanel = document.getElementById('roomPanel');
    const roomOwnerEl = document.getElementById('roomOwner');
    const roomCountEl = document.getElementById('roomCount');
    const playersArea = document.getElementById('playersArea');
    const myNickEl = document.getElementById('myNick');
    const btnStart = document.getElementById('btnStart');
    const btnRestart = document.getElementById('btnRestart');
    const btnLeave = document.getElementById('btnLeave');
    const noticeEl = document.getElementById('notice');

    const app = initializeApp(EXTERNAL_FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const roomRef = doc(db, ROOM_PATH);

    let currentUser = null;
    let gameState = null;
    let myNickname = '';

    function log(...args){ console.log(...args); logEl.textContent += args.map(a => (typeof a==='object'?JSON.stringify(a):String(a))).join(' ')+"\n"; logEl.scrollTop = logEl.scrollHeight; }
    function setStatus(s){ statusEl.textContent = s; }

    async function doAnonymousAuth(){ try { const cred = await signInAnonymously(auth); log('signed in uid=',cred.user.uid);} catch(e){log('auth failed',e); setStatus('Auth 失敗');}}
    onAuthStateChanged(auth,(user)=>{currentUser=user;if(user){setStatus('已登入：'+user.uid);subscribeRoom();}else{setStatus('未登入');}});

    let unsubscribe = null;
    function subscribeRoom(){
      if(unsubscribe) return;
      unsubscribe = onSnapshot(roomRef,(snap)=>{
        if(!snap.exists()){ gameState=null; renderUI(); setStatus('房間不存在'); return;}
        gameState = snap.data(); renderUI(); setStatus('已連到房間');
      }, err=>{log('snapshot err',err); setStatus('訂閱失敗');});
    }

    // number buttons state
    let activeNumbers = {}; // {1:true,2:false,...}

    function renderNumberButtons(){
      const container = document.getElementById('numberButtons');
      container.innerHTML='';
      const colors = {1:'#FFD700',2:'#0000FF',3:'#FF0000',4:'#800080',5:'#FFA500',6:'#008000',7:'#A52A2A',8:'#000000',9:'#FFD700',10:'#0000FF',11:'#FF0000',12:'#800080',13:'#FFA500'};
      for(let i=1;i<=13;i++){
        const btn=document.createElement('div');
        btn.className='number-btn';
        btn.textContent=i;
        btn.style.backgroundColor=colors[i]||'#fff';
        if(activeNumbers[i]) btn.classList.add('active');
        btn.onclick = ()=>{ toggleNumber(i); };
        container.appendChild(btn);
      }
    }

    function toggleNumber(n){
      activeNumbers[n] = !activeNumbers[n];
      renderNumberButtons();
      console.log('切換號碼', n, '狀態', activeNumbers[n]);
      // TODO: 後續同步到 Firebase 或牌顯示邏輯
    }

    function renderUI(){
      const players = (gameState && gameState.players) ? gameState.players : {};
      const cleanPlayers = {};
      Object.keys(players).forEach(k=>{ if(players[k] && typeof players[k]==='object' && players[k].id) cleanPlayers[k]=players[k]; });

      if(!gameState){ joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); myNickEl.textContent='—'; return;}
      const amInRoom = currentUser && cleanPlayers[currentUser.uid];
      if(!amInRoom){ joinPanel.classList.remove('hidden'); roomPanel.classList.add('hidden'); roomOwnerEl.textContent = cleanPlayers[gameState.creatorId]?.nickname||'—'; roomCountEl.textContent = `${Object.keys(cleanPlayers).length}/${MAX_PLAYERS}`; return;}

      joinPanel.classList.add('hidden'); roomPanel.classList.remove('hidden');
      myNickname = cleanPlayers[currentUser.uid].nickname||myNickname;
      myNickEl.textContent = myNickname;
      roomOwnerEl.textContent = cleanPlayers[gameState.creatorId]?.nickname||'—';
      roomCountEl.textContent = `${Object.keys(cleanPlayers).length} / ${MAX_PLAYERS}`;
      noticeEl.textContent = gameState.notice || '';

      const amHost = gameState.creatorId===currentUser.uid && myNickname==='kai';
      if(amHost){ btnStart.classList.remove('hidden'); btnRestart.classList.remove('hidden'); }
      else { btnStart.classList.add('hidden'); btnRestart.classList.add('hidden'); }

      playersArea.innerHTML='';
      const pList = Object.values(cleanPlayers);
      pList.sort((a,b)=>a.id===currentUser.uid?-1:(b.id===currentUser.uid?1:0));
      pList.forEach(p=>{
        const wrapper=document.createElement('div');
        wrapper.className='p-3 rounded bg-slate-800 border border-slate-700';
        const header=document.createElement('div');
        header.className='player-header mb-2';
        const left=document.createElement('div');
        left.innerHTML=`<strong>${p.nickname||('p_'+p.id.slice(0,6))}</strong>${p.id===currentUser.uid?'<span class="small"> (您)</span>':''}`;
        const right=document.createElement('div');
        right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
        const countSpan=document.createElement('div'); countSpan.className='small'; countSpan.textContent=`牌 ${(p.cards||[]).length} / ${CARDS_PER_PLAYER + MAX_EXTRA}`;

        // foul button
        const foulBtn=document.createElement('button');
        foulBtn.className='foul-btn';
        foulBtn.textContent='犯規 +1';
        const deckLen = (gameState && Array.isArray(gameState.deck))?gameState.deck.length:0;
        if(!gameState.gameStarted) foulBtn.disabled=true;
        if((p.cards||[]).length>=CARDS_PER_PLAYER+MAX_EXTRA) foulBtn.disabled=true;
        if(deckLen===0) foulBtn.disabled=true;
        foulBtn.onclick=()=>{ if(p.id!==currentUser.uid){setStatus('只能為自己按犯規'); return;} foulDrawFor(p.id); };
        right.appendChild(countSpan); right.appendChild(foulBtn);

        header.appendChild(left); header.appendChild(right); wrapper.appendChild(header);
        const cardsRow=document.createElement('div'); cardsRow.className='flex gap-2 flex-wrap';
        (p.cards||[]).forEach(c=>{
          const cardEl=document.createElement('div'); cardEl.className='card';
          const isMine = p.id===currentUser.uid; const isMarked = (p.marked||[]).includes(c);
          if(isMarked) cardEl.classList.add('marked');
          if(isMine){ cardEl.classList.add('card-face'); cardEl.textContent=c; cardEl.style.cursor='pointer'; cardEl.title=isMarked?'已標記':'點擊以標記'; cardEl.onclick=()=>markCard(p.id,c); if(c[0]==='♥'||c[0]==='♦') cardEl.classList.add('suit-red'); else cardEl.classList.add('suit-black'); }
          else { if(isMarked){cardEl.classList.add('card-face'); cardEl.textContent=c; if(c[0]==='♥'||c[0]==='♦') cardEl.classList.add('suit-red'); else cardEl.classList.add('suit-black'); } else {cardEl.classList.add('card-back'); cardEl.textContent=' ';} }
          cardsRow.appendChild(cardEl);
        });
        wrapper.appendChild(cardsRow);
        playersArea.appendChild(wrapper);
      });

      // render number buttons
      renderNumberButtons();
    }

    // ---------- placeholder functions ----------
    async function markCard(pid, cardCode){ if(!currentUser || !gameState) return; if(pid!==currentUser.uid){setStatus('只能標記自己的卡'); return;} try{ await updateDoc(roomRef,{[`players.${currentUser.uid}.marked`]: arrayUnion(cardCode), updatedAt: serverTimestamp()}); setStatus('已標記 ' + cardCode);} catch(e){log('mark err',e); setStatus('標記失敗');}}

    async function foulDrawFor(playerId){ if(!currentUser) return; console.log('犯規抽牌', playerId); /* 保留現有邏輯 */ }

    (async function(){ await doAnonymousAuth(); })();
  </script>
</body>
</html>

