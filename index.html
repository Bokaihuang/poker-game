<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pool Poker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: white; }
.ball, .stripe-ball {
  width: 40px; height: 40px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white;
  box-shadow: inset -2px -2px 5px rgba(0,0,0,0.3), 2px 2px 5px rgba(0,0,0,0.3); cursor:pointer;
}
.stripe-ball { background:white; position:relative; overflow:hidden; }
.stripe-ball::before {
  content:''; position:absolute; top:25%; bottom:25%; left:0; right:0; background: var(--stripe-color);
}
.stripe-text { position:relative; z-index:10; background:white; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold; color:black;}
</style>
</head>
<body>
<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0",
  authDomain: "poolpokergame-b88ed.firebaseapp.com",
  projectId: "poolpokergame-b88ed",
  storageBucket: "poolpokergame-b88ed.firebasestorage.app",
  messagingSenderId: "574863840102",
  appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ROOM_PATH = "artifacts/poolpokergame-b88ed/public/data/main-room";
</script>

<script type="text/babel">
const { useState, useEffect } = React;

const BALL_COLORS = {
  1:'yellow',2:'blue',3:'red',4:'purple',5:'orange',6:'green',7:'brown',8:'black',
  9:'yellow',10:'blue',11:'red',12:'purple',13:'orange'
};

const App = () => {
  const [user, setUser] = useState(null);
  const [gameState, setGameState] = useState(null);
  const [nickname, setNickname] = useState('');
  const [loading, setLoading] = useState(true);
  const [errorMsg, setErrorMsg] = useState('');

  useEffect(()=>{
    signInAnonymously(auth).catch(console.error);
    const unsub = onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
    return () => unsub();
  },[]);

  useEffect(()=>{
    if(!user) return;
    const docRef = doc(db, ROOM_PATH);
    const unsub = onSnapshot(docRef, docSnap => {
      if(docSnap.exists()) setGameState(docSnap.data());
      else setGameState(null);
    });
    return ()=> unsub();
  },[user]);

  const joinRoom = async () => {
    if(!nickname.trim()) { setErrorMsg("è«‹è¼¸å…¥æš±ç¨±"); return; }
    const myId = user.uid;
    const docRef = doc(db, ROOM_PATH);
    try {
      if(!gameState) {
        // å»ºç«‹æˆ¿é–“
        const players = { [myId]: { id: myId, nickname:nickname.trim(), cards:[], marked:[] } };
        await setDoc(docRef, { creatorId:nickname==='kai'?myId:null, totalPlayers:2, gameStarted:false, cardsPerPlayer:8, players, ballsStatus:{} });
      } else {
        // åŠ å…¥æˆ¿é–“
        if(Object.keys(gameState.players||{}).length>=5) { setErrorMsg("æˆ¿é–“å·²æ»¿"); return; }
        await updateDoc(docRef, { [`players.${myId}`]: { id:myId, nickname:nickname.trim(), cards:[], marked:[] } });
      }
      setErrorMsg('');
    } catch(e){ console.error(e); setErrorMsg("åŠ å…¥å¤±æ•—"); }
  };

  const leaveRoom = async () => {
    if(!user || !gameState) return;
    const myId = user.uid;
    const docRef = doc(db, ROOM_PATH);
    try{
      const newPlayers = {...gameState.players};
      delete newPlayers[myId];
      const ballsStatus = gameState.ballsStatus||{};
      if(gameState.creatorId===myId){
        // æˆ¿ä¸»é€€å‡ºï¼Œæ¸…ç©ºæˆ¿é–“
        await setDoc(docRef, { creatorId:null, totalPlayers:2, gameStarted:false, cardsPerPlayer:8, players:{}, ballsStatus:{} });
      } else {
        await updateDoc(docRef, { players:newPlayers });
      }
    }catch(e){console.error(e);}
  };

  const startGame = async () => {
    if(!gameState) return;
    if(gameState.creatorId!==user.uid) { setErrorMsg("åªæœ‰æˆ¿ä¸»å¯ç™¼ç‰Œ"); return; }
    let deck = [];
    for(let i=1;i<=13;i++) deck.push(i,i,i,i);
    deck.sort(()=>Math.random()-0.5);
    const newPlayers = {};
    const cardsPerPlayer = gameState.cardsPerPlayer || 8;
    Object.values(gameState.players).forEach((p,i)=>{
      newPlayers[p.id] = {...p, cards:deck.slice(i*cardsPerPlayer,(i+1)*cardsPerPlayer), marked:[]};
    });
    const docRef = doc(db, ROOM_PATH);
    await updateDoc(docRef,{ players:newPlayers, gameStarted:true, ballsStatus:{} });
  };

  const toggleBall = async (num) => {
    if(!gameState) return;
    const docRef = doc(db, ROOM_PATH);
    const ballsStatus = {...(gameState.ballsStatus||{})};
    ballsStatus[num] = !ballsStatus[num];
    const newPlayers = {...gameState.players};
    Object.values(newPlayers).forEach(p=>{
      const marked = new Set(p.marked||[]);
      if(ballsStatus[num]) marked.add(num);
      else marked.delete(num);
      p.marked = Array.from(marked);
    });
    await updateDoc(docRef,{ ballsStatus, players:newPlayers });
  };

  if(loading || !user){
    return <div className="h-screen flex items-center justify-center text-white">é€£ç·šä¸­...</div>;
  }

  const isJoined = gameState && gameState.players && gameState.players[user.uid];
  const isCreator = gameState && gameState.creatorId===user.uid;

  if(!isJoined){
    return <div className="min-h-screen flex items-center justify-center">
      <div className="bg-slate-800 p-8 rounded-xl w-80 flex flex-col gap-4">
        <h1 className="text-2xl text-emerald-400 text-center font-bold">ğŸ± Pool Poker</h1>
        {errorMsg && <div className="text-red-400 text-center">{errorMsg}</div>}
        <input type="text" value={nickname} onChange={e=>setNickname(e.target.value)} placeholder="æš±ç¨±" className="p-2 rounded w-full text-black"/>
        <button onClick={joinRoom} className="bg-emerald-600 p-2 rounded text-white font-bold">åŠ å…¥æˆ¿é–“</button>
      </div>
    </div>;
  }

  return <div className="min-h-screen bg-slate-900 flex flex-col p-4">
    <div className="flex justify-between mb-4 items-center">
      <span className="text-white font-bold">æˆ¿é–“: main-room</span>
      <div className="flex gap-2">
        {isCreator && <button onClick={startGame} className="bg-yellow-600 px-2 py-1 rounded">ç™¼ç‰Œé–‹å§‹</button>}
        <button onClick={leaveRoom} className="bg-red-600 px-2 py-1 rounded">é€€å‡ºæˆ¿é–“</button>
      </div>
    </div>

    {/* çƒå€ */}
    {gameState.gameStarted && <div className="flex flex-wrap gap-2 mb-4">
      {Array.from({length:13},(_,i)=>i+1).map(num=>{
        const isStripe = num>8;
        const marked = gameState.ballsStatus?.[num];
        return <div key={num} onClick={()=>toggleBall(num)} className={isStripe?'stripe-ball ball':'ball'} style={{backgroundColor:!isStripe?BALL_COLORS[num]:'white','--stripe-color':BALL_COLORS[num], opacity:marked?0.4:1}}>
          {isStripe?<span className="stripe-text">{num}</span>:num}
        </div>;
      })}
    </div>}

    {/* ç©å®¶ç‰Œ */}
    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
      {Object.values(gameState.players).map(p=>{
        const isMe = p.id===user.uid;
        return <div key={p.id} className={`p-4 rounded-xl border ${isMe?'border-emerald-400':'border-slate-700'} bg-slate-800`}>
          <div className="flex justify-between mb-2">
            <span>{p.nickname}{isMe?' (æ‚¨)':''}</span>
            <span>{p.marked?.length||0} å·²æ¨™è¨˜</span>
          </div>
          <div className="flex flex-wrap gap-2">
            {p.cards && p.cards.map((c,i)=>{
              const marked = p.marked.includes(c);
              return <div key={i} className={`w-10 h-14 rounded flex items-center justify-center ${marked?'bg-yellow-400 text-black':'bg-white text-black'}`}>
                {c}
              </div>;
            })}
          </div>
        </div>;
      })}
    </div>
  </div>;
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>



