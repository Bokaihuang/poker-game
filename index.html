<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pool Poker — main-room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#071024; color:#e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

    .card { width:54px; height:74px; border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.6); }
    .card-back { background:linear-gradient(180deg,#0b1220,#081228); border:2px solid rgba(255,255,255,.04); color:transparent; }
    .card-face { background:white; color:#071024; border:2px solid rgba(2,6,23,.06); }
    .marked { outline:3px solid #f59e0b; transform:scale(1.05); }
    .small { font-size:.85rem; color:#cfe8ff; }
    .suit-red { color:#dc2626; }
    .suit-black { color:#111827; }
    .foul-btn { background:#ef4444; color:white; padding:6px 8px; border-radius:6px; font-weight:600; cursor:pointer; border:none; }
    .foul-btn[disabled] { opacity:0.5; cursor:not-allowed; }
    .player-header { display:flex; gap:8px; align-items:center; justify-content:space-between; }

    /* ===== 球按鈕 美化 ===== */
    .ball-btn {
      width:40px;
      height:40px;
      border-radius:50%;
      font-weight:700;
      cursor:pointer;
      border: 2px solid transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      margin:4px;
      user-select:none;
      transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease, filter 160ms ease;
      color: #071024;
      font-size: 14px;
      text-align:center;
      line-height:1;
    }

    .ball-btn:hover {
      transform: translateY(-3px) scale(1.03);
      filter: brightness(1.06);
    }
    .ball-btn:active {
      transform: translateY(0) scale(0.98);
    }
    .ball-btn.selected {
      border-color: #ffffff;
      box-shadow: 0 8px 18px rgba(255,255,255,0.08), 0 0 8px rgba(255,255,255,0.12);
      transform: scale(1.12);
      filter: brightness(1.08);
    }

    /* 單色球 */
    .ball-yellow { background:#fff59b; }
    .ball-blue   { background:#2b7cff; color:white; }
    .ball-red    { background:#ff5252; color:white; }
    .ball-purple { background:#8d5cff; color:white; }
    .ball-orange { background:#ff8c2b; }
    .ball-green  { background:#28c76f; color:black; }
    .ball-maroon { background:#7a2f2f; color:white; }
    .ball-black  { background: radial-gradient(circle at 30% 30%, #3b3b3b, #000000 60%); color:white; border-color: rgba(255,255,255,0.06); }

    /* 條紋球 9~13 */
    .ball-9  { background: linear-gradient(to bottom, white 20%, #fff59b 20%, #fff59b 80%, white 80%); }
    .ball-10 { background: linear-gradient(to bottom, white 20%, #2b7cff 20%, #2b7cff 80%, white 80%); color:white; }
    .ball-11 { background: linear-gradient(to bottom, white 20%, #ff5252 20%, #ff5252 80%, white 80%); color:white; }
    .ball-12 { background: linear-gradient(to bottom, white 20%, #8d5cff 20%, #8d5cff 80%, white 80%); color:white; }
    .ball-13 { background: linear-gradient(to bottom, white 20%, #ff8c2b 20%, #ff8c2b 80%, white 80%); }

    @media (max-width:640px){
      .ball-btn { width:34px; height:34px; font-size:13px; margin:3px; }
    }
  </style>
</head>
<body>
<div class="max-w-5xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Pool Poker — main-room</h1>

  <div id="status" class="mb-4 text-sm small">初始化中…</div>

  <div id="joinPanel" class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
    <div class="col-span-2">
      <label class="small">暱稱</label>
      <input id="nickname" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="輸入暱稱" />
    </div>
    <div>
      <button id="btnJoin" class="w-full py-2 rounded bg-emerald-600 hover:bg-emerald-500">加入房間</button>
    </div>
  </div>

  <div id="roomPanel" class="mb-6 p-4 rounded bg-slate-900 border border-slate-700 hidden">
    <div class="flex items-center justify-between mb-3">
      <div><div class="text-xs small">房間 ID</div><div class="font-mono">main-room</div></div>
      <div><div class="text-xs small">房主</div><div id="roomOwner" class="font-bold">—</div></div>
      <div><div class="text-xs small">人數</div><div id="roomCount">0 / 5</div></div>
      <div><div class="text-xs small">我的暱稱</div><div id="myNick" class="font-mono">—</div></div>
    </div>

    <div class="flex gap-2 items-center mb-4">
      <button id="btnStart" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-500 hidden">發牌（房主）</button>
      <button id="btnRestart" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 hidden">重開（房主）</button>
      <button id="btnLeave" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 ml-auto">退出房間</button>
      <div id="notice" class="ml-4 small text-slate-300"></div>
    </div>

    <div id="ballButtons" class="mb-4"></div>

    <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

  <div id="debug" class="mt-6 p-3 rounded bg-slate-900 border border-slate-700 text-xs small">
    <div><strong>Debug (console)</strong></div>
    <pre id="log" class="text-xs mt-2"></pre>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc,
    deleteDoc, serverTimestamp, arrayUnion, deleteField, runTransaction
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const EXTERNAL_FIREBASE_CONFIG = {
    apiKey: "AIzaSyCk54DEp6rzvpfQBBNW_iJByZ3boyHEPF0",
    authDomain: "poolpokergame-b88ed.firebaseapp.com",
    projectId: "poolpokergame-b88ed",
    storageBucket: "poolpokergame-b88ed.firebasestorage.app",
    messagingSenderId: "574863840102",
    appId: "1:574863840102:web:14368aaf84b3640c6eeea7"
  };

  const APP_ID = EXTERNAL_FIREBASE_CONFIG.projectId;
  const ROOM_PATH = `artifacts/${APP_ID}/public/data/pool_poker_rooms/main_room`;
  const CARDS_PER_PLAYER = 8;
  const MAX_PLAYERS = 5;
  const MAX_EXTRA = 6;

  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const nicknameInput = document.getElementById('nickname');
  const btnJoin = document.getElementById('btnJoin');
  const joinPanel = document.getElementById('joinPanel');
  const roomPanel = document.getElementById('roomPanel');
  const roomOwnerEl = document.getElementById('roomOwner');
  const roomCountEl = document.getElementById('roomCount');
  const playersArea = document.getElementById('playersArea');
  const myNickEl = document.getElementById('myNick');
  const btnStart = document.getElementById('btnStart');
  const btnRestart = document.getElementById('btnRestart');
  const btnLeave = document.getElementById('btnLeave');
  const noticeEl = document.getElementById('notice');
  const ballButtonsEl = document.getElementById('ballButtons');

  const app = initializeApp(EXTERNAL_FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const roomRef = doc(db, ROOM_PATH);

  let currentUser = null;
  let gameState = null;
  let myNickname = '';
  let revealedNumbers = [];

  function log(...args){ console.log(...args); logEl.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' ')+'\n'; logEl.scrollTop = logEl.scrollHeight;}
  function setStatus(s){ statusEl.textContent = s; }

  async function doAnonymousAuth(){
    setStatus('使用匿名登入 Firebase...');
    try{ const cred=await signInAnonymously(auth); log('signed in uid=', cred.user.uid); } 
    catch(e){ log('auth failed', e); setStatus('Auth 失敗'); }
  }

  onAuthStateChanged(auth,(user)=>{ currentUser=user; if(user){ setStatus('已登入：'+user.uid); subscribeRoom(); } else { setStatus('未登入'); } });

  let unsubscribe=null;
  function subscribeRoom(){
    if(unsubscribe) return;
    setStatus('訂閱 main-room...');
    unsubscribe = onSnapshot(roomRef,(snap)=>{
      if(!snap.exists()){ gameState=null; renderUI(); setStatus('房間尚未建立或已被清空'); return; }
      gameState = snap.data(); renderUI(); setStatus('已連到房間');
    }, (err)=>{ log('snapshot err',err); setStatus('訂閱失敗'); });
  }

  const suits=['♣','♦','♥','♠'];
  const rankMap={1:'A',11:'J',12:'Q',13:'K'};
  function buildDeck(){ const deck=[]; for(let r=1;r<=13;r++){ for(let s=0;s<4;s++){ const rank=rankMap[r]||String(r); deck.push({suit:suits[s], rank, code:`${suits[s]}${rank}`}); } } return deck; }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  // ---------- 圓形按鈕 (美化 + selected class) ----------
  function toggleNumber(n) {
    const idx = revealedNumbers.indexOf(n);
    if (idx >= 0) revealedNumbers.splice(idx, 1);
    else revealedNumbers.push(n);
  }

  function renderBallButtons(){
    ballButtonsEl.innerHTML='';
    for(let n=1;n<=13;n++){
      const btn=document.createElement('button');
      btn.className='ball-btn';
      btn.textContent=n;

      // 顏色對應撞球
      if(n===1||n===9) { btn.classList.add(n>=9?'ball-9':'ball-yellow'); }
      else if(n===2||n===10) { btn.classList.add(n>=9?'ball-10':'ball-blue'); }
      else if(n===3||n===11) { btn.classList.add(n>=9?'ball-11':'ball-red'); }
      else if(n===4||n===12) { btn.classList.add(n>=9?'ball-12':'ball-purple'); }
      else if(n===5||n===13) { btn.classList.add(n>=9?'ball-13':'ball-orange'); }
      else if(n===6) { btn.classList.add('ball-green'); }
      else if(n===7) { btn.classList.add('ball-maroon'); }
      else if(n===8) { btn.classList.add('ball-black'); }

      if (revealedNumbers.includes(n)) btn.classList.add('selected');

      btn.onclick = () => {
        toggleNumber(n);
        renderUI();
        renderBallButtons();
      };

      ballButtonsEl.appendChild(btn);
    }
  }

  // ---------- Join / Leave / Start / Restart ----------
  btnJoin.addEventListener('click', async()=>{ /* ...原 join 程式碼 ... */ });
  btnLeave.addEventListener('click', async()=>{ /* ...原 leave 程式碼 ... */ });
  btnStart.addEventListener('click', async()=>{ /* ...原 start 程式碼 ... */ });
  btnRestart.addEventListener('click', async()=>{ /* ...原 restart 程式碼 ... */ });

  function renderUI(){ /* ...原 renderUI 程式碼 ... */ }
  async function markCard(pid, cardCode){ /* ...原 markCard 程式碼 ... */ }
  async function foulDrawFor(playerId){ /* ...原 foulDrawFor 程式碼 ... */ }

  (async function(){ await doAnonymousAuth(); })();
  renderBallButtons();
</script>
</body>
</html>

